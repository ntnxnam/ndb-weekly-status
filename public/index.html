<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Point Calculator</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #000000;
            color: #ffffff;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: #999;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: #ffffff;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: #333;
            border-left-color: #ffffff;
        }

        .nav-item.active {
            background: #333;
            border-left-color: #ffffff;
        }

        /* Main Content */
        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .main-content.sidebar-open {
            margin-left: 250px;
        }

        /* Header */
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .hamburger {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .hamburger span {
            width: 20px;
            height: 2px;
            background: #000000;
            transition: 0.3s;
        }

        .hamburger.open span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.open span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.open span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Content - Minimal, Tight */
        .content {
            padding: 16px 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Controls - Compact */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .jql-input {
            flex: 1;
            min-width: 250px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            background: #ffffff;
        }

        .jql-input:focus {
            outline: none;
            border-color: #000000;
        }

        /* Filters */
        .filters-section {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }

        .filters-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #000;
        }

        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 14px;
            background: #fff;
            min-height: 40px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #000;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #000000;
            background: #ffffff;
            color: #000000;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            font-weight: 500;
        }

        .btn:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn.primary {
            background: #000000;
            color: #ffffff;
        }

        .btn.primary:hover {
            background: #333333;
        }

        /* Stats - Compact */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 6px 10px;
            text-align: center;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            color: #666;
            line-height: 1.2;
        }

        /* Table - Minimal, Lean Design */
        .table-container {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: block; /* Always show container */
        }

        .table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 400px);
            position: relative;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }

        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table th {
            background: #fafafa;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        .table tbody tr {
            transition: background 0.15s ease;
        }

        .table tbody tr:hover {
            background: #f9f9f9;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Compact cell content */
        .table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table td.summary-cell {
            max-width: 300px;
            white-space: normal;
            line-height: 1.4;
        }

        /* Pagination Styles */
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }

        /* Compact controls */
        .table-controls {
            font-size: 12px;
        }

        .table-controls input,
        .table-controls select {
            font-size: 12px;
            padding: 6px 10px;
        }

        /* Scrollbar styling */
        .table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-todo { background: #f0f0f0; color: #666; }
        .status-in-progress { background: #e5e5e5; color: #000; }
        .status-done { background: #000; color: #fff; }

        /* Links */
        .link {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
        }

        .link:hover {
            text-decoration: underline;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            color: #000;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #ffffff;
            margin: 10% auto;
            padding: 0;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: #666;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #000;
        }

        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #000;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }


        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }

            .main-content.sidebar-open {
                margin-left: 0;
            }

            .controls {
                flex-direction: column;
            }

            .jql-input {
                min-width: auto;
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .stat-card {
                padding: 6px 10px;
            }
            
            .stat-number {
                font-size: 16px;
            }
            
            .stat-label {
                font-size: 9px;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 10px;
            }
        }

        /* Overlay for mobile */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        /* Insights Section */
        .insights-section {
            margin: 20px 0;
        }

        .insights-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .insight-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .insight-card:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .feature-selector-section {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .feature-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #ffffff;
            border: 2px solid #e5e5e5;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .feature-chip:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .feature-chip.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .feature-chip .feature-key {
            font-weight: 600;
            color: #667eea;
        }

        .feature-chip.active .feature-key {
            color: white;
        }

        .feature-chip .feature-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            background: #f3f4f6;
            color: #666;
        }

        .feature-chip.active .feature-status {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        /* Executive View Styles */
        .executive-view {
            padding: 20px;
        }

        .executive-summary-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .executive-summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .executive-summary-card .number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .executive-summary-card .label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f8f8;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .breakdown-item:hover {
            background: #e8e8e8;
        }

        .breakdown-item .type-name {
            font-weight: 600;
            font-size: 14px;
        }

        .breakdown-item .type-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .hierarchical-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .hierarchical-item .level-1 {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .hierarchical-item .level-2 {
            font-size: 16px;
            font-weight: 600;
            color: #764ba2;
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .hierarchical-item .level-3 {
            font-size: 14px;
            font-weight: 500;
            color: #10b981;
            margin-left: 40px;
            margin-bottom: 5px;
        }

        .hierarchical-item .level-4 {
            font-size: 12px;
            color: #666;
            margin-left: 60px;
            margin-bottom: 3px;
        }

        .feature-card {
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .feature-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .feature-card.expanded {
            border-color: #667eea;
            background: #ffffff;
        }

        .feature-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feature-card-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .feature-card-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }

        .feature-card-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e5e5;
        }

        .feature-card.expanded .feature-card-details {
            display: block;
        }

        .feature-card.expanded .feature-card-header span:last-child {
            transform: rotate(180deg);
        }

        @media (max-width: 768px) {
            .breakdown-sections {
                grid-template-columns: 1fr !important;
            }
        }

        /* Feature Metrics Modal */
        .feature-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .feature-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }

        .feature-modal-content {
            background-color: #ffffff;
            margin: 20px auto;
            padding: 0;
            border-radius: 8px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .feature-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .feature-modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .feature-modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .feature-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .feature-modal-body {
            padding: 30px;
        }

        .metrics-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e5e5;
        }

        .metrics-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .metrics-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .metrics-tab:hover {
            color: #667eea;
        }

        .metrics-tab-content {
            display: none;
        }

        .metrics-tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e5e5e5;
        }

        .metric-card h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .metric-chart-container {
            position: relative;
            height: 300px;
            margin-top: 10px;
        }

        .metric-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-summary-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        .metric-summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-summary-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .timeline-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .timeline-table th,
        .timeline-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }

        .timeline-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .timeline-table tr:hover {
            background: #f8f9fa;
        }

        .story-point-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #667eea;
            color: white;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.todo { background: #e5e5e5; color: #333; }
        .status-badge.in-progress { background: #3b82f6; color: white; }
        .status-badge.done { background: #10b981; color: white; }
        .status-badge.blocked { background: #ef4444; color: white; }

        .priority-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-badge.critical,
        .priority-badge.highest,
        .priority-badge.blocker { background: #ef4444; color: white; }
        .priority-badge.high,
        .priority-badge.major { background: #f59e0b; color: white; }
        .priority-badge.medium,
        .priority-badge.normal { background: #3b82f6; color: white; }
        .priority-badge.low,
        .priority-badge.minor { background: #10b981; color: white; }
        .priority-badge.lowest,
        .priority-badge.trivial { background: #e5e5e5; color: #333; }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Kick Off Epic Due Dates */
        .kickoff-epic-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #e5e5e5;
        }

        .kickoff-epic-section h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .due-dates-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .due-date-group {
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
            overflow: hidden;
        }

        .due-date-group.overdue {
            border-left: 4px solid #ef4444;
        }

        .due-date-group.today {
            border-left: 4px solid #3b82f6;
        }

        .due-date-group.upcoming {
            border-left: 4px solid #10b981;
        }

        .due-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e5e5;
        }

        .due-date-label {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .due-date-count {
            font-size: 12px;
            color: #666;
            background: white;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .due-date-tasks {
            padding: 10px 15px;
        }

        .due-date-task {
            display: grid;
            grid-template-columns: 100px 1fr auto auto;
            gap: 15px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .due-date-task:last-child {
            border-bottom: none;
        }

        .task-key a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            font-size: 12px;
        }

        .task-key a:hover {
            text-decoration: underline;
        }

        .task-summary {
            font-size: 13px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .task-assignee {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">NDB Status</div>
            <div class="sidebar-subtitle">Weekly Dashboard</div>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="showDashboard()">Dashboard</a>
            <a href="#" class="nav-item" onclick="showExecutiveView()">üìä Executive View</a>
            <a href="config.html" class="nav-item">Configure Columns</a>
            <a href="#" class="nav-item" onclick="fetchAllData()">Fetch All Data</a>
        </nav>
    </div>

    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <button class="hamburger" id="hamburger" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1 class="header-title">Story Point Calculator</h1>
            <div class="header-actions">
            </div>
        </header>

        <!-- Content -->
        <div class="content">

            <!-- Controls -->
            <div class="controls">
                <input type="text" id="customJql" class="jql-input" placeholder="Enter JQL query (e.g., filter = 165194)" value="filter = 165194" style="flex: 1; min-width: 300px;">
                <button class="btn" onclick="testAndAuthenticateJira(this)" style="background: #3b82f6; color: white;" title="Test and authenticate Jira token">
                    üîê Test Jira
                </button>
                <button class="btn" onclick="testAndAuthenticateConfluence(this)" style="background: #8b5cf6; color: white;" title="Test and authenticate Confluence token">
                    üîê Test Confluence
                </button>
                <button class="btn primary" onclick="fetchAllData()">Fetch Data</button>
                <a href="config.html" class="btn">Configure Columns</a>
            </div>

            <!-- Executive Summary Cards -->
            <div id="executiveSummary" class="executive-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; display: none;"></div>

            <!-- Dynamic Status Stats - will be populated with actual statuses -->
            <div class="stats" id="stats" style="display: none;"></div>

            <!-- Actionable Insights Section -->
            <div id="insightsSection" class="insights-section" style="display: none; background: #ffffff; border: 1px solid #e5e5e5; border-radius: 4px; padding: 20px; margin: 20px 0;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 15px;">üìä Actionable Insights</h3>
                <div id="insightsContent" class="insights-content"></div>
            </div>

            <!-- Executive View Section -->
            <div id="executiveView" class="executive-view" style="display: none;">
                <div class="executive-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px;">
                    <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 10px;">üìä Release Overview</h2>
                    <p style="font-size: 16px; opacity: 0.9;">Executive dashboard with hierarchical breakdown and drill-down capabilities</p>
                </div>

                <!-- Executive Summary Cards -->
                <div class="executive-summary" id="executiveSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Breakdown Sections -->
                <div class="breakdown-sections" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Type Breakdown -->
                    <div class="breakdown-card" style="background: #ffffff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 20px;">
                        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">üìã Breakdown by Type</h3>
                        <div id="typeBreakdown" class="breakdown-content"></div>
                    </div>

                    <!-- Priority Breakdown -->
                    <div class="breakdown-card" style="background: #ffffff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 20px;">
                        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">‚ö° Breakdown by Priority</h3>
                        <div id="priorityBreakdown" class="breakdown-content"></div>
                    </div>
                </div>

                <!-- Hierarchical View -->
                <div class="hierarchical-view" style="background: #ffffff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">üèóÔ∏è Hierarchical Structure</h3>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        X-FEAT/Capability ‚Üí Feature/Initiative ‚Üí Epic ‚Üí Task/Bug/Test/Improvement
                    </p>
                    <div id="hierarchicalContent" class="hierarchical-content"></div>
                </div>

                <!-- Feature Drill-Down -->
                <div class="feature-drilldown" style="background: #ffffff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">üîç Feature Drill-Down</h3>
                    <div id="featureDrillDown" class="drilldown-content"></div>
                </div>

            </div>

            <!-- Loading State -->
            <div id="loading" class="loading" style="display: none;">
                Loading issues...
            </div>

            <!-- Error State -->
            <div id="error" class="error" style="display: none;">
                <p id="errorMessage"></p>
            </div>

            <!-- Issues Table -->
            <div class="table-container">
                <!-- Table Controls -->
                <div class="table-controls" style="display: none; padding: 12px 16px; background: #fafafa; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;" id="tableControls">
                    <div class="table-info" style="font-size: 12px; color: #666;">
                        <span id="tableInfo">Showing 0 tickets</span>
                    </div>
                    <div class="table-actions" style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="tableSearch" placeholder="Search table..." style="padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px; width: 200px;" onkeyup="searchTable()">
                    </div>
                </div>
                
                <!-- Table Wrapper with Scroll -->
                <div class="table-wrapper">
                    <table class="table" id="issuesTable" style="display: none;">
                        <thead id="tableHeader"></thead>
                        <tbody id="issuesTableBody"></tbody>
                    </table>
                </div>
                
            </div>
        </div>
    </div>


    <script>
        let currentIssues = [];
        let filteredIssues = [];
        let allIssues = []; // Store all tickets in background (for count columns)
        let tableConfig = null;
        let userColumns = [];
        let draggedElement = null;
        let fieldNameMap = {}; // Map field ID to field name
        let confluencePageTitles = {}; // Map field ID to Confluence page title (for CG/PG)
        let currentPage = 1; // Current page number for pagination
        let pageSize = 50; // Number of items per page
        let totalTicketsFromAPI = 0; // Store total from API response
        let searchQuery = ''; // Current search query

        // Sidebar functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const hamburger = document.getElementById('hamburger');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('open');
            mainContent.classList.toggle('sidebar-open');
            hamburger.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function showDashboard() {
            toggleSidebar();
            // Hide executive view
            const executiveView = document.getElementById('executiveView');
            if (executiveView) {
                executiveView.style.display = 'none';
            }
            
            // Show regular dashboard elements
            const content = document.querySelector('.content');
            if (content) {
                Array.from(content.children).forEach(child => {
                    if (child.id !== 'executiveView') {
                        child.style.display = '';
                    }
                });
            }
        }

        function showExecutiveView() {
            toggleSidebar();
            // Hide regular dashboard
            const regularContent = document.querySelector('.content');
            Array.from(regularContent.children).forEach(child => {
                if (child.id !== 'executiveView' && child.id !== 'authModal') {
                    child.style.display = 'none';
                }
            });
            
            // Show executive view
            const executiveView = document.getElementById('executiveView');
            executiveView.style.display = 'block';
            
            // Build executive dashboard if we have data
            if (currentIssues && currentIssues.length > 0) {
                buildExecutiveDashboard(currentIssues);
            } else {
                // Fetch data first
                fetchAllData().then(() => {
                    if (currentIssues && currentIssues.length > 0) {
                        buildExecutiveDashboard(currentIssues);
                    }
                });
            }
        }

        // Build Executive Dashboard
        function buildExecutiveDashboard(issues) {
            buildExecutiveSummary(issues);
            buildTypeBreakdown(issues);
            buildPriorityBreakdown(issues);
            buildHierarchicalView(issues);
            buildFeatureDrillDown(issues);
            // Note: Confluence summaries are fetched on demand via button
        }


        // Build Executive Summary Cards
        function buildExecutiveSummary(issues) {
            const summaryContainer = document.getElementById('executiveSummary');
            if (!summaryContainer) {
                // Create summary container if it doesn't exist
                const insightsSection = document.getElementById('insightsSection');
                if (insightsSection && insightsSection.parentNode) {
                    const newSummaryContainer = document.createElement('div');
                    newSummaryContainer.id = 'executiveSummary';
                    newSummaryContainer.className = 'executive-summary';
                    newSummaryContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;';
                    insightsSection.parentNode.insertBefore(newSummaryContainer, insightsSection);
                } else {
                    return; // Can't create summary without container
                }
            }
            
            summaryContainer.innerHTML = '';
            
            // Calculate story points metrics
            let totalStoryPoints = 0;
            let completedStoryPoints = 0;
            let remainingStoryPoints = 0;
            
            // Calculate risk and overdue counts
            let atRiskCount = 0;
            let overdueCount = 0;
            let unassignedCount = 0;
            
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            issues.forEach(issue => {
                // Story points
                const sp = parseFloat(issue.customfield_10002 || issue.storyPoints || 0);
                totalStoryPoints += sp;
                
                const status = (issue.status?.name || issue.status || '').toLowerCase();
                const isResolved = status.includes('done') || status.includes('closed') || status.includes('resolved');
                
                if (isResolved) {
                    completedStoryPoints += sp;
                } else {
                    remainingStoryPoints += sp;
                }
                
                // Risk indicator
                const riskIndicator = (issue.customfield_23560 || '').toLowerCase();
                if (riskIndicator.includes('at risk') || riskIndicator.includes('risk')) {
                    atRiskCount++;
                }
                
                // Overdue items
                if (issue.duedate) {
                    const dueDate = new Date(issue.duedate);
                    dueDate.setHours(0, 0, 0, 0);
                    if (dueDate < now && !isResolved) {
                        overdueCount++;
                    }
                }
                
                // Unassigned
                if (!issue.assignee || issue.assignee === '-' || issue.assignee === 'Unassigned') {
                    unassignedCount++;
                }
            });
            
            const progressPercent = totalStoryPoints > 0 ? Math.round((completedStoryPoints / totalStoryPoints) * 100) : 0;
            
            const summaryCards = [
                { 
                    label: 'Total Story Points', 
                    value: `${totalStoryPoints} (Done: ${completedStoryPoints}, Remaining: ${remainingStoryPoints})`, 
                    color: '#667eea' 
                },
                { 
                    label: 'Progress', 
                    value: `${progressPercent}% Complete`, 
                    color: '#10b981' 
                },
                { 
                    label: 'At Risk', 
                    value: atRiskCount, 
                    color: '#ef4444' 
                },
                { 
                    label: 'Overdue', 
                    value: overdueCount, 
                    color: '#f59e0b' 
                },
                { 
                    label: 'Unassigned', 
                    value: unassignedCount, 
                    color: '#6b7280' 
                }
            ];
            
            summaryCards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'executive-summary-card';
                cardDiv.style.borderTop = `4px solid ${card.color}`;
                cardDiv.innerHTML = `
                    <div class="number" style="color: ${card.color}; font-size: 24px; font-weight: 700;">${card.value}</div>
                    <div class="label" style="font-size: 12px; color: #666; margin-top: 5px;">${card.label}</div>
                `;
                summaryContainer.appendChild(cardDiv);
            });
        }

        // Build Type Breakdown
        function buildTypeBreakdown(issues) {
            const breakdownContainer = document.getElementById('typeBreakdown');
            breakdownContainer.innerHTML = '';
            
            const typeMap = {};
            issues.forEach(issue => {
                const type = issue.issuetype || 'Unknown';
                typeMap[type] = (typeMap[type] || 0) + 1;
            });
            
            const sortedTypes = Object.entries(typeMap)
                .sort((a, b) => b[1] - a[1]);
            
            sortedTypes.forEach(([type, count]) => {
                const item = document.createElement('div');
                item.className = 'breakdown-item';
                item.onclick = () => filterByType(type);
                item.innerHTML = `
                    <span class="type-name">${type}</span>
                    <span class="type-count">${count}</span>
                `;
                breakdownContainer.appendChild(item);
            });
        }

        // Build Priority Breakdown
        function buildPriorityBreakdown(issues) {
            const breakdownContainer = document.getElementById('priorityBreakdown');
            breakdownContainer.innerHTML = '';
            
            const priorityMap = {};
            issues.forEach(issue => {
                const priority = issue.priority || 'Unprioritized';
                priorityMap[priority] = (priorityMap[priority] || 0) + 1;
            });
            
            const priorityOrder = ['Critical', 'High', 'Medium', 'Low', 'Lowest', 'Unprioritized'];
            const sortedPriorities = Object.entries(priorityMap)
                .sort((a, b) => {
                    const aIndex = priorityOrder.indexOf(a[0]);
                    const bIndex = priorityOrder.indexOf(b[0]);
                    if (aIndex === -1 && bIndex === -1) return 0;
                    if (aIndex === -1) return 1;
                    if (bIndex === -1) return -1;
                    return aIndex - bIndex;
                });
            
            sortedPriorities.forEach(([priority, count]) => {
                const item = document.createElement('div');
                item.className = 'breakdown-item';
                item.onclick = () => filterByPriority(priority);
                
                let priorityColor = '#6b7280';
                if (priority.toLowerCase().includes('critical')) priorityColor = '#dc2626';
                else if (priority.toLowerCase().includes('high')) priorityColor = '#ef4444';
                else if (priority.toLowerCase().includes('medium')) priorityColor = '#f59e0b';
                else if (priority.toLowerCase().includes('low')) priorityColor = '#10b981';
                
                item.innerHTML = `
                    <span class="type-name">${priority}</span>
                    <span class="type-count" style="background: ${priorityColor}">${count}</span>
                `;
                breakdownContainer.appendChild(item);
            });
        }

        // Build Hierarchical View
        function buildHierarchicalView(issues) {
            const hierarchicalContainer = document.getElementById('hierarchicalContent');
            hierarchicalContainer.innerHTML = '';
            
            // Group by hierarchy level
            const capabilities = [];
            const features = [];
            const epics = [];
            const tasks = [];
            
            issues.forEach(issue => {
                const type = (issue.issuetype || '').toLowerCase();
                const key = issue.key || '';
                
                if (type.includes('capability') || key.includes('X-FEAT')) {
                    capabilities.push(issue);
                } else if (type.includes('feature') || type.includes('initiative')) {
                    features.push(issue);
                } else if (type.includes('epic')) {
                    epics.push(issue);
                } else {
                    tasks.push(issue);
                }
            });
            
            // Display hierarchy
            if (capabilities.length > 0) {
                capabilities.forEach(cap => {
                    const item = document.createElement('div');
                    item.className = 'hierarchical-item';
                    item.innerHTML = `
                        <div class="level-1">üèõÔ∏è ${cap.key}: ${cap.summary || 'N/A'}</div>
                    `;
                    hierarchicalContainer.appendChild(item);
                });
            }
            
            if (features.length > 0) {
                features.forEach(feat => {
                    const item = document.createElement('div');
                    item.className = 'hierarchical-item';
                    item.innerHTML = `
                        <div class="level-2">üéØ ${feat.key}: ${feat.summary || 'N/A'}</div>
                    `;
                    hierarchicalContainer.appendChild(item);
                });
            }
            
            if (epics.length > 0) {
                epics.forEach(epic => {
                    const item = document.createElement('div');
                    item.className = 'hierarchical-item';
                    item.innerHTML = `
                        <div class="level-3">üì¶ ${epic.key}: ${epic.summary || 'N/A'}</div>
                    `;
                    hierarchicalContainer.appendChild(item);
                });
            }
            
            if (tasks.length > 0) {
                const taskGroups = {};
                tasks.forEach(task => {
                    const type = task.issuetype || 'Task';
                    if (!taskGroups[type]) taskGroups[type] = [];
                    taskGroups[type].push(task);
                });
                
                Object.entries(taskGroups).forEach(([type, typeTasks]) => {
                    const item = document.createElement('div');
                    item.className = 'hierarchical-item';
                    item.innerHTML = `
                        <div class="level-4">
                            <strong>${type}:</strong> ${typeTasks.length} tickets
                            ${typeTasks.slice(0, 5).map(t => `<a href="${t.url}" target="_blank" style="margin-left: 10px; color: #3b82f6;">${t.key}</a>`).join('')}
                            ${typeTasks.length > 5 ? ` +${typeTasks.length - 5} more` : ''}
                        </div>
                    `;
                    hierarchicalContainer.appendChild(item);
                });
            }
        }

        // Store feature ticket data
        let featureTicketData = {}; // { featureKey: { allTickets: [], belowEpic: [] } }

        // Build Feature Drill-Down
        function buildFeatureDrillDown(issues) {
            const drillDownContainer = document.getElementById('featureDrillDown');
            drillDownContainer.innerHTML = '';
            
            // Get all features and initiatives
            const features = issues.filter(issue => {
                const type = (issue.issuetype || '').toLowerCase();
                return type.includes('feature') || type.includes('initiative');
            });
            
            if (features.length === 0) {
                drillDownContainer.innerHTML = '<p style="color: #666;">No features or initiatives found. Use the Feature/Initiative Tracker to fetch related tickets.</p>';
                return;
            }
            
            // Add a button to fetch all features at once
            const fetchAllButton = document.createElement('div');
            fetchAllButton.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px;';
            fetchAllButton.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="font-size: 16px;">üìä Fetch All Feature Tickets</strong>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                            Click to fetch all tickets (below epic level) for all ${features.length} features/initiatives. This will update the total ticket count.
                        </p>
                    </div>
                    <button class="btn primary" onclick="fetchAllFeatureTickets()" id="fetchAllFeaturesBtn">
                        üîç Fetch All
                    </button>
                </div>
                <div id="fetchAllProgress" style="display: none; margin-top: 10px; font-size: 14px; color: #666;"></div>
            `;
            drillDownContainer.appendChild(fetchAllButton);
            
            features.forEach(feature => {
                const featureCard = document.createElement('div');
                featureCard.className = 'feature-card';
                featureCard.id = `feature-${feature.key}`;
                featureCard.onclick = (e) => {
                    // Don't toggle if clicking the link or button
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button')) {
                        return;
                    }
                    featureCard.classList.toggle('expanded');
                };
                
                const status = feature.status || 'Unknown';
                const priority = feature.priority || 'Unprioritized';
                
                // Check if we have fetched data for this feature
                const featureData = featureTicketData[feature.key];
                const hasData = featureData && featureData.belowEpic && featureData.belowEpic.length > 0;
                
                const relatedCount = hasData ? featureData.belowEpic.length : 0;
                const relatedBugs = hasData ? featureData.belowEpic.filter(t => {
                    const type = (t.issuetype || '').toLowerCase();
                    return type.includes('bug');
                }).length : 0;
                const relatedTasks = hasData ? featureData.belowEpic.filter(t => {
                    const type = (t.issuetype || '').toLowerCase();
                    return type.includes('task') || type.includes('story') || type.includes('improvement') || type.includes('test');
                }).length : 0;
                const relatedEpics = hasData ? featureData.allTickets.filter(t => {
                    const type = (t.issuetype || '').toLowerCase();
                    return type.includes('epic');
                }).length : 0;
                
                featureCard.innerHTML = `
                    <div class="feature-card-header">
                        <div>
                            <div class="feature-card-title">${feature.key}: ${feature.summary || 'N/A'}</div>
                            <div class="feature-card-stats">
                                <span>Status: ${status}</span>
                                <span>Priority: ${priority}</span>
                                <span style="font-weight: 600; color: ${hasData ? '#10b981' : '#f59e0b'}">
                                    ${hasData ? `Tickets: ${relatedCount}` : 'Not fetched'}
                                </span>
                            </div>
                        </div>
                        <span style="font-size: 20px; transition: transform 0.2s;">‚ñº</span>
                    </div>
                    <div class="feature-card-details">
                        ${hasData ? `
                        <div style="margin-bottom: 15px;">
                            <strong>Related Tickets Breakdown (Below Epic Level):</strong>
                            <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px;">
                                <span>üêõ Bugs: ${relatedBugs}</span>
                                <span>üìã Tasks/Stories: ${relatedTasks}</span>
                                <span>üì¶ Epics: ${relatedEpics}</span>
                                <span>üìä Total Below Epic: ${relatedCount}</span>
                            </div>
                        </div>
                        ` : `
                        <div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 4px;">
                            <p style="margin: 0; color: #92400e; font-size: 14px;">
                                ‚ö†Ô∏è Click "Fetch All Related Tickets" to get accurate counts of all tickets below epic level.
                            </p>
                        </div>
                        `}
                        <div style="margin-bottom: 10px;">
                            <button class="btn primary" onclick="fetchFeatureTicketsFor('${feature.key}', true)" style="margin-right: 10px;">
                                üîç Fetch All Related Tickets
                            </button>
                            <a href="${feature.url}" target="_blank" style="color: #3b82f6; text-decoration: none; padding: 8px 16px; border: 1px solid #3b82f6; border-radius: 4px; display: inline-block;">
                                View in Jira ‚Üí
                            </a>
                        </div>
                    </div>
                `;
                drillDownContainer.appendChild(featureCard);
            });
        }

        // Fetch all tickets for all features
        async function fetchAllFeatureTickets() {
            const features = currentIssues.filter(issue => {
                const type = (issue.issuetype || '').toLowerCase();
                return type.includes('feature') || type.includes('initiative');
            });
            
            if (features.length === 0) {
                alert('No features or initiatives found in current data.');
                return;
            }
            
            const fetchAllBtn = document.getElementById('fetchAllFeaturesBtn');
            const progressDiv = document.getElementById('fetchAllProgress');
            fetchAllBtn.disabled = true;
            fetchAllBtn.textContent = '‚è≥ Fetching...';
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = `Fetching tickets for ${features.length} features...`;
            
            let totalBelowEpic = 0;
            let completed = 0;
            
            // Fetch tickets for each feature sequentially to avoid overwhelming the API
            for (const feature of features) {
                try {
                    progressDiv.innerHTML = `Fetching ${feature.key}... (${completed + 1}/${features.length})`;
                    
                    const storedToken = localStorage.getItem('jira_bearer_token');
                    if (!storedToken) {
                        throw new Error('Please authenticate first.');
                    }
                    
                    const jql = generateFeatureJQL(feature.key);
                    const url = `http://localhost:7842/api/fetch-all-data?jql=${encodeURIComponent(jql)}&t=${Date.now()}`;
                    const response = await fetch(url, {
                        headers: {
                            'X-Jira-Token': storedToken
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.issues) {
                        // Filter tickets below epic level
                        const belowEpic = data.issues.filter(issue => {
                            const type = (issue.issuetype || '').toLowerCase();
                            return !type.includes('epic') && !type.includes('feature') && !type.includes('initiative') && !type.includes('capability');
                        });
                        
                        featureTicketData[feature.key] = {
                            allTickets: data.issues,
                            belowEpic: belowEpic
                        };
                        
                        totalBelowEpic += belowEpic.length;
                        completed++;
                    } else {
                        console.error(`Failed to fetch tickets for ${feature.key}:`, data.error);
                        completed++;
                    }
                } catch (err) {
                    console.error(`Error fetching tickets for ${feature.key}:`, err);
                    completed++;
                }
            }
            
            // Update the UI
            buildFeatureDrillDown(currentIssues);
            buildExecutiveSummary(currentIssues);
            
            fetchAllBtn.disabled = false;
            fetchAllBtn.textContent = 'üîç Fetch All';
            progressDiv.innerHTML = `‚úÖ Completed! Fetched ${totalBelowEpic} tickets below epic level across ${features.length} features.`;
            progressDiv.style.color = '#10b981';
            
            // Update total ticket count in summary
            setTimeout(() => {
                progressDiv.style.display = 'none';
            }, 5000);
        }

        // Filter functions
        function filterByType(type) {
            document.getElementById('customJql').value = `issuetype = "${type}"`;
            fetchAllData();
            showDashboard();
        }

        function filterByPriority(priority) {
            document.getElementById('customJql').value = `priority = "${priority}"`;
            fetchAllData();
            showDashboard();
        }

        // API functions
        async function loadTableConfig() {
            try {
                console.log('Loading table config from http://localhost:7842/api/table-config');
                // Force reload by adding timestamp and cache-busting headers
                const response = await fetch('http://localhost:7842/api/table-config?t=' + Date.now(), {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Table config response:', data);
                
                if (data.success) {
                    tableConfig = data.config;
                    userColumns = [...data.config.userColumns];
                    console.log('Table config loaded successfully:', tableConfig);
                } else {
                    throw new Error(data.error || 'Failed to load table configuration');
                }
            } catch (err) {
                console.error('Error loading table config:', err);
                tableConfig = {
                    defaultColumns: [
                        { key: 'key', label: 'Key', type: 'link', jiraField: 'key', isDefault: true, isEditable: false },
                        { key: 'summary', label: 'Summary', type: 'text', jiraField: 'summary', isDefault: true, isEditable: false }
                    ],
                    userColumns: [],
                    allColumns: []
                };
                userColumns = [];
            }
        }

        function createTableHeader() {
            const tableHeader = document.getElementById('tableHeader');
            tableHeader.innerHTML = '';
            
            // Use allColumns (defaultColumns + userColumns) instead of just defaultColumns
            const columnsToUse = (tableConfig && tableConfig.allColumns && tableConfig.allColumns.length > 0) 
                ? tableConfig.allColumns 
                : (tableConfig && tableConfig.defaultColumns ? tableConfig.defaultColumns : []);
            
            if (!columnsToUse || columnsToUse.length === 0) {
                console.warn('No table configuration available for headers');
                return;
            }
            
            // Special columns for ticket counts
            const specialColumns = [
                { key: 'outstandingTasks', label: 'Outstanding Tasks' },
                { key: 'bugs', label: 'Bugs' },
                { key: 'tests', label: 'Tests' },
                { key: 'otherTickets', label: 'Other Tickets' }
            ];
            
            const row = document.createElement('tr');
            columnsToUse.forEach(column => {
                // Only show active columns (if active property exists)
                if (column.active !== false) {
                    const th = document.createElement('th');
                    let displayName = column.label;
                    
                    // Special handling for Confluence fields (CG/PG) - use page title or default
                    if (column.type === 'confluence') {
                        if (column.key === 'pg' || column.jiraField === 'customfield_10001') {
                            displayName = confluencePageTitles['customfield_10001'] || 'PG Completion';
                        } else if (column.key === 'cg' || column.jiraField === 'customfield_10000') {
                            displayName = confluencePageTitles['customfield_10000'] || 'CG Completion';
                        } else {
                            displayName = column.label || column.key;
                        }
                    }
                    // For custom fields (but NOT CG/PG Confluence fields), prioritize fieldNameMap over hardcoded label
                    else if (column.key && (column.key.startsWith('customfield_') || column.jiraField?.startsWith('customfield_'))
                             && column.jiraField !== 'customfield_10000' && column.jiraField !== 'customfield_10001') {
                        const fieldId = column.key.startsWith('customfield_') ? column.key : column.jiraField;
                        // Check if we have a real field name from Jira API
                        const fieldNameFromMap = fieldNameMap[fieldId] || fieldNameMap[column.key] || fieldNameMap[column.jiraField];
                        if (fieldNameFromMap) {
                            displayName = fieldNameFromMap; // Override label with actual field name
                            console.log(`‚úÖ Using field name from Jira: ${fieldId} -> "${fieldNameFromMap}"`);
                        } else {
                            // Fall back to label or key if field name not loaded yet
                            displayName = column.label || column.key;
                            console.log(`‚ö†Ô∏è Field name not found in map for ${fieldId}, using label: "${displayName}"`);
                        }
                    } else if (!displayName) {
                        // For non-custom fields, use label or key
                        displayName = column.label || column.key;
                    }
                    
                    th.textContent = displayName;
                    th.className = 'px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50';
                    row.appendChild(th);
                }
            });
            
            // Add special column headers
            specialColumns.forEach(specialCol => {
                const th = document.createElement('th');
                th.textContent = specialCol.label;
                th.className = 'px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50';
                th.style.cursor = 'help';
                th.title = 'Click count to view JQL query';
                row.appendChild(th);
            });
            
            tableHeader.appendChild(row);
        }


        async function fetchAllData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const issuesTable = document.getElementById('issuesTable');
            const stats = document.getElementById('stats');
            let customJql = document.getElementById('customJql').value;
            console.log('üîç [fetchAllData] Original JQL:', customJql);

            // Fix common typo: fixVerison -> fixVersion
            if (customJql && customJql.includes('fixVerison')) {
                console.warn('‚ö†Ô∏è [fetchAllData] Fixed typo: "fixVerison" -> "fixVersion"');
                customJql = customJql.replace(/fixVerison/gi, 'fixVersion');
                document.getElementById('customJql').value = customJql;
                console.log('‚úÖ [fetchAllData] Corrected JQL:', customJql);
            }
            
            // Fix fixVersion syntax: ensure values in parentheses are quoted if not already
            // Example: fixVersion in (NBD-2.10) -> fixVersion in ("NBD-2.10")
            // Or: fixVersion = NBD-2.10 -> fixVersion = "NBD-2.10"
            if (customJql && customJql.includes('fixVersion')) {
                // Fix fixVersion in (...) syntax
                customJql = customJql.replace(/fixVersion\s+in\s*\(([^)]+)\)/gi, (match, values) => {
                    // Check if values are already quoted
                    if (!values.includes('"') && !values.includes("'")) {
                        // Quote each value
                        const quotedValues = values.split(',').map(v => {
                            const trimmed = v.trim();
                            return `"${trimmed}"`;
                        }).join(', ');
                        return `fixVersion in (${quotedValues})`;
                    }
                    return match;
                });
                
                // Fix fixVersion = value syntax (single value, not in parentheses)
                customJql = customJql.replace(/fixVersion\s*=\s*([^\s\)]+)/gi, (match, value) => {
                    // Don't quote if it's already quoted or is a variable
                    if (!value.includes('"') && !value.includes("'") && !value.startsWith('$')) {
                        return `fixVersion = "${value}"`;
                    }
                    return match;
                });
                
                if (customJql !== document.getElementById('customJql').value) {
                    console.log('‚úÖ [fetchAllData] Fixed fixVersion syntax:', customJql);
                    document.getElementById('customJql').value = customJql;
                }
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            issuesTable.style.display = 'none';
            stats.style.display = 'none';

            try {
                const storedToken = localStorage.getItem('jira_bearer_token');
                if (!storedToken) {
                    throw new Error('Please authenticate first. Click the Authenticate button.');
                }
                
                const url = customJql ? `http://localhost:7842/api/fetch-all-data?jql=${encodeURIComponent(customJql)}&t=${Date.now()}` : `http://localhost:7842/api/fetch-all-data?t=${Date.now()}`;
                console.log('üåê [fetchAllData] Sending request with JQL:', customJql);
                console.log('üåê [fetchAllData] Request URL:', url);
                
                const headers = {
                        'X-Jira-Token': storedToken
                };
                
                // Add Confluence token if available
                const confluenceToken = localStorage.getItem('confluence_bearer_token');
                if (confluenceToken) {
                    headers['X-Confluence-Token'] = confluenceToken;
                    console.log('üîë [fetchAllData] Using separate Confluence token');
                } else {
                    console.log('üîë [fetchAllData] Using Jira token for Confluence');
                }
                
                const response = await fetch(url, {
                    headers: headers
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: errorText };
                    }
                    
                    let errorMessage = errorData.error || errorData.message || errorText || `HTTP ${response.status}: ${response.statusText}`;
                    
                    // Provide helpful suggestions for common JQL errors
                    if (errorMessage.includes("does not exist for the field 'fixVersion'")) {
                        errorMessage += '\n\nüí° Tip: The fixVersion value might not exist in Jira, or it might need quotes. Try:\n' +
                                      '   - Check if the version name is correct (e.g., "NDB-2.10" vs "NBD-2.10")\n' +
                                      '   - Use quotes: fixVersion in ("NDB-2.10")\n' +
                                      '   - Or use equals: fixVersion = "NDB-2.10"';
                    } else if (errorMessage.includes('fixVersion')) {
                        errorMessage += '\n\nüí° Tip: Make sure fixVersion values are quoted, e.g., fixVersion in ("NDB-2.10")';
                    }
                    
                    throw new Error(`HTTP ${response.status}: ${errorMessage}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    console.log('Data fetched successfully. Issues count:', data.issues ? data.issues.length : 0);
                    console.log('üìä Total tickets from API:', data.total || 0);
                    
                    // Store total from API
                    totalTicketsFromAPI = data.total || 0;
                    
                    // Store all tickets in background
                    allIssues = data.issues || [];
                    console.log('üì¶ Total issues received:', allIssues.length);
                    console.log('üì¶ Sample issue structure:', allIssues.length > 0 ? Object.keys(allIssues[0]) : 'No issues');
                    if (allIssues.length > 0) {
                        console.log('üì¶ First issue full structure:', JSON.stringify(allIssues[0], null, 2));
                    }
                    
                    // Filter to show only FEAT or INITIATIVE tickets
                    // Check multiple possible field names for issuetype
                    let featOrInitiative = allIssues.filter(issue => {
                        if (!issue) return false;
                        
                        // Try different possible field names for issuetype
                        let type = '';
                        if (issue.issuetype) {
                            if (typeof issue.issuetype === 'string') {
                                type = issue.issuetype;
                            } else if (typeof issue.issuetype === 'object') {
                                type = issue.issuetype.name || issue.issuetype.value || '';
                            } else {
                                type = String(issue.issuetype);
                            }
                        } else if (issue.type) {
                            // Try 'type' as alternative
                            type = typeof issue.type === 'string' ? issue.type : (issue.type?.name || '');
                        } else if (issue.fields && issue.fields.issuetype) {
                            // Check nested fields structure
                            const it = issue.fields.issuetype;
                            type = typeof it === 'string' ? it : (it.name || it.value || '');
                        }
                        
                        const normalizedType = type.toLowerCase();
                        const isFeatOrInitiative = normalizedType.includes('feat') || normalizedType.includes('initiative');
                        
                        // Debug: log first few issues to see structure
                        if (allIssues.indexOf(issue) < 3) {
                            console.log('üîç Sample issue filter check:', {
                                key: issue.key,
                                hasIssuetype: !!issue.issuetype,
                                issuetype: issue.issuetype,
                                hasType: !!issue.type,
                                type: issue.type,
                                normalizedType: normalizedType,
                                isFeatOrInitiative: isFeatOrInitiative
                            });
                        }
                        
                        return isFeatOrInitiative;
                    });
                    
                    console.log(`Filtered to ${featOrInitiative.length} FEAT/INITIATIVE tickets from ${allIssues.length} total tickets`);
                    
                    // If no FEAT/INITIATIVE found, show all issues instead of empty table
                    if (featOrInitiative.length === 0 && allIssues.length > 0) {
                        console.warn('No FEAT/INITIATIVE tickets found. Showing all issues.');
                        console.log('Sample issue types found:', allIssues.slice(0, 5).map(i => ({
                            key: i.key,
                            issuetype: i.issuetype
                        })));
                        featOrInitiative = allIssues; // Show all issues if no FEAT/INITIATIVE found
                    }
                    
                    currentIssues = featOrInitiative;
                    console.log('‚úÖ Final issues to display:', featOrInitiative.length);
                    console.log('‚úÖ Sample final issue:', featOrInitiative.length > 0 ? {
                        key: featOrInitiative[0].key,
                        summary: featOrInitiative[0].summary,
                        issuetype: featOrInitiative[0].issuetype,
                        allKeys: Object.keys(featOrInitiative[0])
                    } : 'No issues');
                    
                    // Load field names for better column display
                    await loadFieldNames();
                    
                    // Recreate table header with updated field names
                    if (tableConfig) {
                        createTableHeader();
                    }
                    
                    console.log('üìä Calling displayIssues with', featOrInitiative.length, 'issues');
                    
                    // CRITICAL: Ensure table container is visible BEFORE calling displayIssues
                    const tableContainer = document.querySelector('.table-container');
                    const tableWrapper = document.querySelector('.table-wrapper');
                    const issuesTable = document.getElementById('issuesTable');
                    const statsDiv = document.getElementById('stats');
                    
                    // Show stats first
                    if (statsDiv) {
                        statsDiv.style.display = 'block';
                        console.log('‚úÖ Stats element displayed');
                    }
                    
                    // Force table container to be visible BEFORE rendering
                    if (tableContainer) {
                        tableContainer.style.display = 'block';
                        tableContainer.style.visibility = 'visible';
                        tableContainer.style.opacity = '1';
                        console.log('‚úÖ Table container made visible BEFORE rendering');
                    }
                    
                    if (tableWrapper) {
                        tableWrapper.style.display = 'block';
                        tableWrapper.style.visibility = 'visible';
                        tableWrapper.style.opacity = '1';
                        console.log('‚úÖ Table wrapper made visible BEFORE rendering');
                    }
                    
                    if (issuesTable) {
                        // Don't set display yet - let renderTable do it after rendering
                        console.log('‚úÖ Table element found');
                    } else {
                        console.error('‚ùå Table element not found!');
                    }
                    
                    // Now display issues (this will call renderTable which will populate the table)
                    displayIssues(featOrInitiative);
                    updateStats(featOrInitiative, totalTicketsFromAPI);
                    buildExecutiveSummary(featOrInitiative);
                    
                    // Show executive summary
                    const execSummary = document.getElementById('executiveSummary');
                    if (execSummary) {
                        execSummary.style.display = 'grid';
                    }
                    
                    // Final check after a short delay to ensure everything is visible
                    setTimeout(() => {
                        const finalTable = document.getElementById('issuesTable');
                        const finalContainer = document.querySelector('.table-container');
                        const finalBody = document.getElementById('issuesTableBody');
                        
                        if (finalTable) {
                            finalTable.style.display = 'table';
                            finalTable.style.visibility = 'visible';
                            finalTable.style.width = '100%';
                            console.log('‚úÖ [Final Check] Table element displayed');
                        }
                        
                        if (finalContainer) {
                            finalContainer.style.display = 'block';
                            finalContainer.style.visibility = 'visible';
                            console.log('‚úÖ [Final Check] Table container displayed');
                        }
                        
                        if (finalBody) {
                            console.log('‚úÖ [Final Check] Table body has', finalBody.children.length, 'rows');
                            if (finalBody.children.length === 0) {
                                console.error('‚ùå [Final Check] Table body is EMPTY!');
                            }
                        }
                    }, 500);
                    
                    // Update executive view if visible
                    const executiveView = document.getElementById('executiveView');
                    if (executiveView && executiveView.style.display !== 'none') {
                        buildExecutiveDashboard(featOrInitiative);
                    }
                    
                    console.log('All data fetched successfully:', data.message);
                } else {
                    throw new Error(data.error || 'Failed to fetch all data');
                }
            } catch (err) {
                console.error('Error fetching all data:', err);
                error.style.display = 'block';
                let errorMsg = err.message || 'Failed to fetch data';
                
                // Provide helpful error messages
                if (err.message && err.message.includes('Failed to fetch')) {
                    errorMsg = 'Failed to connect to server. Please make sure the server is running on http://localhost:7842. Check the browser console for more details.';
                } else if (errorMsg.includes('authenticate') || errorMsg.includes('token')) {
                    errorMsg += ' Please click the "Test Jira" button and enter your Bearer token.';
                } else if (errorMsg.includes('HTTP 401') || errorMsg.includes('HTTP 403')) {
                    errorMsg += ' Your token may be invalid or expired. Please re-authenticate using the "Test Jira" button.';
                }
                
                document.getElementById('errorMessage').textContent = errorMsg;
            } finally {
                loading.style.display = 'none';
            }
        }

        async function refreshColumns() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const issuesTable = document.getElementById('issuesTable');
            const stats = document.getElementById('stats');
            
            // Check if we have existing data to re-render
            if (!allIssues || allIssues.length === 0) {
                error.style.display = 'block';
                document.getElementById('errorMessage').textContent = 'No data available. Please click "Fetch Data" first to load data, then use "Refresh Columns" to apply rendering changes.';
                return;
            }
            
            console.log('üîÑ [refreshColumns] Re-rendering existing data with updated rendering logic');
            console.log('üìä [refreshColumns] Re-rendering', allIssues.length, 'total issues');

            loading.style.display = 'block';
            error.style.display = 'none';
            
            try {
                // Filter to show only FEAT or INITIATIVE tickets (same logic as fetchAllData)
                let featOrInitiative = allIssues.filter(issue => {
                    if (!issue) return false;
                    
                    // Try different possible field names for issuetype
                    let type = '';
                    if (issue.issuetype) {
                        if (typeof issue.issuetype === 'string') {
                            type = issue.issuetype;
                        } else if (typeof issue.issuetype === 'object') {
                            type = issue.issuetype.name || issue.issuetype.value || '';
                        } else {
                            type = String(issue.issuetype);
                        }
                    } else if (issue.type) {
                        type = typeof issue.type === 'string' ? issue.type : (issue.type?.name || '');
                    } else if (issue.fields && issue.fields.issuetype) {
                        const it = issue.fields.issuetype;
                        type = typeof it === 'string' ? it : (it.name || it.value || '');
                    }
                    
                    const normalizedType = type.toLowerCase();
                    return normalizedType.includes('feat') || normalizedType.includes('initiative');
                });
                
                // If no FEAT/INITIATIVE found, show all issues
                if (featOrInitiative.length === 0 && allIssues.length > 0) {
                    featOrInitiative = allIssues;
                }
                
                currentIssues = featOrInitiative;
                
                // Load field names for better column display (in case field names were updated)
                await loadFieldNames();
                
                // Re-render everything with updated rendering logic
                displayIssues(featOrInitiative);
                updateStats(featOrInitiative, totalTicketsFromAPI || allIssues.length);
                buildExecutiveSummary(featOrInitiative);
                
                // Show executive summary
                const execSummary = document.getElementById('executiveSummary');
                if (execSummary) {
                    execSummary.style.display = 'grid';
                }
                    
                    // Show the table
                    if (issuesTable) {
                        issuesTable.style.display = 'table';
                    }
                    
                // Show stats
                if (stats) {
                    stats.style.display = 'block';
                }
                
                console.log('‚úÖ [refreshColumns] Re-rendering complete with', featOrInitiative.length, 'issues');
            } catch (err) {
                console.error('Error refreshing columns:', err);
                error.style.display = 'block';
                document.getElementById('errorMessage').textContent = `Error re-rendering: ${err.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayIssues(issues) {
            console.log('üîµ [displayIssues] START - Called with', issues ? issues.length : 0, 'issues');
            
            if (!Array.isArray(issues)) {
                console.error('‚ùå [displayIssues] issues is not an array:', issues);
                issues = [];
            }
            
            // Store issues
            currentIssues = issues;
            filteredIssues = [...issues];
            currentPage = 1;
            
            console.log('‚úÖ [displayIssues] Stored issues:', {
                currentIssues: currentIssues.length,
                filteredIssues: filteredIssues.length,
                sampleIssue: issues.length > 0 ? {
                    key: issues[0].key,
                    summary: issues[0].summary?.substring(0, 50),
                    hasData: Object.keys(issues[0]).length
                } : null
            });
            
            // Ensure table config is loaded before rendering
            if (!tableConfig || !tableConfig.allColumns || tableConfig.allColumns.length === 0) {
                console.log('‚è≥ [displayIssues] Table config not loaded, loading now...');
                loadTableConfig().then(() => {
                    console.log('‚úÖ [displayIssues] Table config loaded');
                    // CRITICAL: Create header FIRST, then render
                    createTableHeader();
                    // Small delay to ensure header is in DOM
                    setTimeout(() => {
                    renderTable();
                    }, 50);
                }).catch(err => {
                    console.error('‚ùå [displayIssues] Failed to load table config:', err);
                    // Try to create header and render anyway
                    createTableHeader();
                    setTimeout(() => {
                        renderTable();
                    }, 50);
                });
            } else {
                console.log('‚úÖ [displayIssues] Table config already loaded');
                // CRITICAL: Create header FIRST, then render
                createTableHeader();
                // Small delay to ensure header is in DOM
                setTimeout(() => {
                renderTable();
                }, 50);
            }
            
            console.log('üîµ [displayIssues] END');
        }

        function renderTable() {
            console.log('üü¢ [renderTable] START');
            console.log('üü¢ [renderTable] filteredIssues:', {
                length: filteredIssues ? filteredIssues.length : 'undefined',
                type: typeof filteredIssues,
                isArray: Array.isArray(filteredIssues),
                sample: filteredIssues && filteredIssues.length > 0 ? {
                    key: filteredIssues[0].key,
                    summary: filteredIssues[0].summary?.substring(0, 30)
                } : null
            });
            
            // Get all table elements
            const tableBody = document.getElementById('issuesTableBody');
            const issuesTable = document.getElementById('issuesTable');
            const tableControls = document.getElementById('tableControls');
            const pagination = document.getElementById('pagination');
            const tableHeader = document.getElementById('tableHeader');
            const tableContainer = document.querySelector('.table-container');
            const tableWrapper = document.querySelector('.table-wrapper');
            
            // Validate critical elements
            if (!tableBody) {
                console.error('‚ùå [renderTable] CRITICAL: Table body element not found!');
                return;
            }
            
            if (!issuesTable) {
                console.error('‚ùå [renderTable] CRITICAL: Table element not found!');
                return;
            }
            
            console.log('‚úÖ [renderTable] All table elements found:', {
                tableBody: !!tableBody,
                issuesTable: !!issuesTable,
                tableHeader: !!tableHeader,
                tableControls: !!tableControls,
                tableContainer: !!tableContainer,
                tableWrapper: !!tableWrapper
            });
            
            // Clear table body
            tableBody.innerHTML = '';
            console.log('‚úÖ [renderTable] Table body cleared');

            if (!Array.isArray(filteredIssues)) {
                console.warn('filteredIssues is not an array, setting to empty array. Current value:', filteredIssues);
                filteredIssues = [];
            }
            
            // If filteredIssues is empty but currentIssues has data, use currentIssues
            if (filteredIssues.length === 0 && currentIssues && currentIssues.length > 0) {
                console.warn('filteredIssues is empty but currentIssues has data. Using currentIssues.');
                filteredIssues = [...currentIssues];
            }

            // Use allColumns (defaultColumns + userColumns) instead of just defaultColumns
            const columnsToUse = (tableConfig && tableConfig.allColumns && tableConfig.allColumns.length > 0) 
                ? tableConfig.allColumns 
                : (tableConfig && tableConfig.defaultColumns ? tableConfig.defaultColumns : []);
            
            console.log('Columns to use:', columnsToUse.length, 'Table config:', tableConfig ? 'exists' : 'missing');
            
            // Filter to only active columns
            const activeColumns = columnsToUse.filter(col => col.active !== false);
            
            // Add special columns for ticket counts
            const specialColumns = [
                { key: 'outstandingTasks', label: 'Outstanding Tasks', type: 'count' },
                { key: 'bugs', label: 'Bugs', type: 'count' },
                { key: 'tests', label: 'Tests', type: 'count' },
                { key: 'otherTickets', label: 'Other Tickets', type: 'count' }
            ];
            
            console.log('Active columns:', activeColumns.length);
            
            // If no columns configured, show error message
            if (activeColumns.length === 0) {
                const row = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 10; // Use a reasonable default
                td.style.textAlign = 'center';
                td.style.color = '#999';
                td.style.padding = '40px';
                td.textContent = 'No columns configured. Please configure columns in the Config page.';
                row.appendChild(td);
                tableBody.appendChild(row);
                if (tableControls) tableControls.style.display = 'none';
                if (pagination) pagination.style.display = 'none';
                console.warn('No active columns found. Table config:', tableConfig);
                return;
            }
            
            if (filteredIssues.length === 0) {
                const row = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = activeColumns.length;
                td.style.textAlign = 'center';
                td.style.color = '#999';
                td.style.padding = '40px';
                td.textContent = 'No issues found';
                row.appendChild(td);
                tableBody.appendChild(row);
                if (tableControls) tableControls.style.display = 'none';
                if (pagination) pagination.style.display = 'none';
            } else {
                // Ensure filteredIssues is an array with valid length
                const totalIssues = Array.isArray(filteredIssues) ? filteredIssues.length : 0;
                
                // Show controls but hide pagination
                if (tableControls) tableControls.style.display = 'flex';
                if (pagination) pagination.style.display = 'none'; // Hide pagination
                
                // Update info - show total count
                if (document.getElementById('tableInfo')) {
                    const total = Number.isInteger(totalIssues) ? totalIssues : 0;
                    const infoText = total > 0 
                        ? `Showing ${total} tickets`
                        : 'No tickets to display';
                    document.getElementById('tableInfo').textContent = infoText;
                }
                
                // Ensure table is visible
                if (issuesTable) {
                    issuesTable.style.display = 'table';
                }
                
                // Render all issues (no pagination)
                filteredIssues.forEach(issue => {
                    const row = document.createElement('tr');
                    
                    // Render regular columns
                    activeColumns.forEach(column => {
                        const td = document.createElement('td');
                        const value = issue[column.key] || '';
                        
                        // Debug logging for CG/PG columns
                        if ((column.key === 'cg' || column.key === 'pg') && filteredIssues.indexOf(issue) === 0) {
                            console.log(`üîç [renderTable] ${column.key.toUpperCase()} column for ${issue.key}:`, {
                                value: value,
                                valueType: typeof value,
                                hasValue: !!value,
                                columnKey: column.key,
                                columnJiraField: column.jiraField
                            });
                        }
                        
                        // Add class for summary column to allow wrapping
                        if (column.key === 'summary') {
                            td.className = 'summary-cell';
                        }
                        
                        switch (column.type) {
                            case 'link':
                                if (column.key === 'key') {
                                    const link = document.createElement('a');
                                    link.href = issue.url;
                                    link.target = '_blank';
                                    link.textContent = value;
                                    link.className = 'link';
                                    td.appendChild(link);
                                } else {
                                    td.textContent = value;
                                }
                                break;
                            case 'confluence':
                                // Handle multiple links with titles
                                let links = [];
                                let linkObjects = [];
                                
                                // Check if we have link objects stored (with titles)
                                const linksKey = column.key + '_links';
                                if (issue[linksKey] && Array.isArray(issue[linksKey])) {
                                    linkObjects = issue[linksKey];
                                } else if (value && value !== 'No link' && value !== '-') {
                                    // Fallback: parse from comma-separated string
                                    if (value.includes(',')) {
                                        links = value.split(',').map(url => url.trim()).filter(url => url && (url.startsWith('http://') || url.startsWith('https://')));
                                    } else if (value.startsWith('http://') || value.startsWith('https://')) {
                                        links = [value];
                                    }
                                }
                                
                                // Helper function to extract title from URL
                                const extractTitleFromUrl = (url) => {
                                    const titleMatch = url.match(/\/pages\/\d+\/([^\/\?]+)/);
                                    if (titleMatch) {
                                        let title = decodeURIComponent(titleMatch[1]);
                                        title = title.replace(/\+/g, ' ').replace(/-/g, ' ').trim();
                                        return title;
                                    }
                                    return null;
                                };
                                
                                if (linkObjects.length > 0) {
                                    // Use link objects with titles
                                    td.innerHTML = linkObjects.map((linkObj, idx) => {
                                        const url = linkObj.url || linkObj;
                                        const title = linkObj.title || extractTitleFromUrl(url) || `Link ${idx + 1}`;
                                        // Extract page title from Confluence URL for header (only for first link)
                                        if (idx === 0 && column.jiraField && (column.jiraField === 'customfield_10000' || column.jiraField === 'customfield_10001')) {
                                            extractConfluencePageTitle(url, column.jiraField);
                                        }
                                        return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #0065ff; text-decoration: underline;">${title}</a>`;
                                    }).join(' | ');
                                } else if (links.length > 0) {
                                    // Fallback: use URLs and extract titles
                                    td.innerHTML = links.map((url, idx) => {
                                        const title = extractTitleFromUrl(url) || `Link ${idx + 1}`;
                                        // Extract page title from Confluence URL for header (only for first link)
                                        if (idx === 0 && column.jiraField && (column.jiraField === 'customfield_10000' || column.jiraField === 'customfield_10001')) {
                                            extractConfluencePageTitle(url, column.jiraField);
                                        }
                                        return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #0065ff; text-decoration: underline;">${title}</a>`;
                                    }).join(' | ');
                                } else {
                                    td.textContent = 'No link';
                                }
                                
                                // Skip the default rendering for confluence type
                                break;
                            case 'badge':
                                const badge = document.createElement('span');
                                let badgeValue = '';
                                if (!value || value === '') {
                                    badgeValue = 'Unknown';
                                } else if (typeof value === 'string') {
                                    badgeValue = value;
                                } else if (typeof value === 'object') {
                                    badgeValue = value.name || value.displayName || value.toString() || 'Unknown';
                                } else {
                                    badgeValue = String(value);
                                }
                                badge.className = `status-badge status-${badgeValue.toLowerCase().replace(/\s+/g, '-')}`;
                                badge.textContent = badgeValue;
                                td.appendChild(badge);
                                break;
                            case 'labelCheck':
                                // Display Yes/No with styling
                                const labelCheck = document.createElement('span');
                                labelCheck.textContent = value || 'No';
                                labelCheck.style.cssText = value === 'Yes' 
                                    ? 'color: #10b981; font-weight: 600;' 
                                    : 'color: #6b7280;';
                                td.appendChild(labelCheck);
                                break;
                            case 'date':
                            case 'datetime':
                                td.textContent = value;
                                break;
                            case 'text':
                            default:
                                // Special handling for customfield_23073 - summarize it
                                if (column.key === 'customfield_23073' || column.jiraField === 'customfield_23073') {
                                    displaySummarizedField(td, value, issue.key, column.key);
                                }
                                // Special handling for customfield_23560 (Risk Indicator) - display with color coding
                                else if (column.key === 'customfield_23560' || column.jiraField === 'customfield_23560') {
                                    if (value && value !== '') {
                                        const riskBadge = document.createElement('span');
                                        riskBadge.textContent = value;
                                        const riskLower = value.toLowerCase();
                                        
                                        // Check for "yellow" or "slight risk" FIRST (before checking for "red" or "big risk")
                                        // This ensures "Yellow - Slight Risk to Plan" matches yellow, not red
                                        if (riskLower.includes('yellow') || riskLower.includes('slight risk')) {
                                            riskBadge.className = 'risk-badge risk-watch';
                                            // Yellow: bright yellow/amber background with dark brown text for visibility
                                            riskBadge.style.cssText = 'background: #fbbf24; color: #78350f; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else if (riskLower.includes('red') || riskLower.includes('at risk') || riskLower.includes('big risk')) {
                                            riskBadge.className = 'risk-badge risk-at-risk';
                                            // Red: bright red background with white text for high contrast
                                            riskBadge.style.cssText = 'background: #ef4444; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else if (riskLower.includes('green') || riskLower.includes('on track') || riskLower.includes('track')) {
                                            riskBadge.className = 'risk-badge risk-on-track';
                                            // Green: bright green background with white text
                                            riskBadge.style.cssText = 'background: #10b981; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else if (riskLower.includes('watch') || riskLower.includes('monitor')) {
                                            riskBadge.className = 'risk-badge risk-watch';
                                            // Yellow: bright yellow/amber background with dark brown text for visibility
                                            riskBadge.style.cssText = 'background: #fbbf24; color: #78350f; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else {
                                            riskBadge.style.cssText = 'padding: 4px 10px; border-radius: 4px; font-size: 11px;';
                                        }
                                        td.appendChild(riskBadge);
                                    } else {
                                        td.textContent = '-';
                                        td.style.color = '#999';
                                    }
                                }
                                // Special handling for story points
                                // Display calculated story points (done/pending/wontFix) if available, otherwise show single value
                                else if (column.key === 'customfield_10002' || column.jiraField === 'customfield_10002') {
                                    // Check if this is a calculated story points object (from child items)
                                    if (value && typeof value === 'object' && value.total !== undefined) {
                                        // Display as "Done: X, Pending: Y, Won't Fix: Z (Total: W)"
                                        const done = value.done || 0;
                                        const pending = value.pending || 0;
                                        const wontFix = value.wontFix || 0;
                                        const total = value.total || 0;
                                        
                                        const spContainer = document.createElement('div');
                                        spContainer.style.cssText = 'display: flex; flex-direction: column; gap: 2px; font-size: 11px;';
                                        
                                        const doneSpan = document.createElement('span');
                                        doneSpan.textContent = `Done: ${done}`;
                                        doneSpan.style.cssText = 'color: #10b981; font-weight: 600;';
                                        
                                        const pendingSpan = document.createElement('span');
                                        pendingSpan.textContent = `Pending: ${pending}`;
                                        pendingSpan.style.cssText = 'color: #ef4444; font-weight: 600;';
                                        
                                        if (wontFix > 0) {
                                            const wontFixSpan = document.createElement('span');
                                            wontFixSpan.textContent = `Won't Fix: ${wontFix}`;
                                            wontFixSpan.style.cssText = 'color: #f59e0b; font-weight: 600;';
                                            spContainer.appendChild(wontFixSpan);
                                        }
                                        
                                        const totalSpan = document.createElement('span');
                                        totalSpan.textContent = `Total: ${total}`;
                                        totalSpan.style.cssText = 'color: #666; font-size: 10px; margin-top: 2px;';
                                        
                                        spContainer.appendChild(doneSpan);
                                        spContainer.appendChild(pendingSpan);
                                        spContainer.appendChild(totalSpan);
                                        td.appendChild(spContainer);
                                    } else {
                                        // Single story points value (fallback)
                                        const spValue = parseFloat(value) || 0;
                                        const spBadge = document.createElement('span');
                                        spBadge.className = 'story-point-badge';
                                        spBadge.textContent = spValue;
                                        td.appendChild(spBadge);
                                    }
                                }
                                // Special handling for due date with overdue highlighting
                                else if (column.key === 'duedate' || column.jiraField === 'duedate') {
                                    if (value) {
                                        const dueDate = new Date(value);
                                        const now = new Date();
                                        now.setHours(0, 0, 0, 0);
                                        dueDate.setHours(0, 0, 0, 0);
                                        
                                        const dateStr = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                        
                                        if (dueDate < now) {
                                            // Overdue - highlight in red
                                            td.style.cssText = 'color: #dc2626; font-weight: 600; background: #fee2e2; padding: 4px 8px; border-radius: 4px;';
                                            td.textContent = dateStr + ' ‚ö†Ô∏è';
                                        } else {
                                            td.textContent = dateStr;
                                        }
                                    } else {
                                        td.textContent = '-';
                                        td.style.color = '#999';
                                    }
                                }
                                // Special handling for assignee - show "-" instead of "Unassigned"
                                else if (column.key === 'assignee') {
                                    if (value && value !== '-' && value !== 'Unassigned') {
                                    td.textContent = value;
                                    } else {
                                        td.textContent = '-';
                                        td.style.color = '#999';
                                    }
                                }
                                // Special handling for % Complete
                                else if (column.key === 'percentComplete' || column.jiraField === 'percentComplete') {
                                    const percent = parseFloat(value) || 0;
                                    const percentBadge = document.createElement('span');
                                    percentBadge.textContent = `${percent}%`;
                                    if (percent === 100) {
                                        percentBadge.style.cssText = 'background: #10b981; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                    } else if (percent >= 75) {
                                        percentBadge.style.cssText = 'background: #3b82f6; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                    } else if (percent >= 50) {
                                        percentBadge.style.cssText = 'background: #f59e0b; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                    } else {
                                        percentBadge.style.cssText = 'background: #e5e5e5; color: #333; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                    }
                                    td.appendChild(percentBadge);
                                }
                                // Special handling for priority - add color coding
                                else if (column.key === 'priority') {
                                    if (value && value !== 'N/A') {
                                        const priorityBadge = document.createElement('span');
                                        priorityBadge.textContent = value;
                                        const priorityLower = value.toLowerCase();
                                        if (priorityLower.includes('critical') || priorityLower.includes('highest') || priorityLower.includes('blocker')) {
                                            priorityBadge.className = 'priority-badge critical';
                                            priorityBadge.style.cssText = 'background: #ef4444; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else if (priorityLower.includes('high') || priorityLower.includes('major')) {
                                            priorityBadge.className = 'priority-badge high';
                                            priorityBadge.style.cssText = 'background: #f59e0b; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else if (priorityLower.includes('medium') || priorityLower.includes('normal')) {
                                            priorityBadge.className = 'priority-badge medium';
                                            priorityBadge.style.cssText = 'background: #3b82f6; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else if (priorityLower.includes('low') || priorityLower.includes('minor')) {
                                            priorityBadge.className = 'priority-badge low';
                                            priorityBadge.style.cssText = 'background: #10b981; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else if (priorityLower.includes('lowest') || priorityLower.includes('trivial')) {
                                            priorityBadge.className = 'priority-badge lowest';
                                            priorityBadge.style.cssText = 'background: #e5e5e5; color: #333; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;';
                                        } else {
                                            priorityBadge.style.cssText = 'padding: 4px 10px; border-radius: 4px; font-size: 11px;';
                                        }
                                        td.appendChild(priorityBadge);
                                    } else {
                                        td.textContent = 'N/A';
                                        td.style.color = '#999';
                                    }
                                } else {
                                    td.textContent = value || '-';
                                }
                                break;
                        }
                        
                        row.appendChild(td);
                    });
                    
                    // Render special count columns
                    specialColumns.forEach(specialCol => {
                        const td = document.createElement('td');
                        td.style.textAlign = 'center';
                        td.style.padding = '8px';
                        
                        const featureKey = issue.key || '';
                        const count = countRelatedTickets(featureKey, specialCol.key === 'outstandingTasks' ? 'tasks' : specialCol.key);
                        const jql = generateJQLForType(featureKey, specialCol.key === 'outstandingTasks' ? 'tasks' : specialCol.key);
                        
                        if (count > 0 && jql) {
                            const link = document.createElement('a');
                            link.href = '#';
                            link.textContent = count;
                            link.style.cssText = 'color: #3b82f6; text-decoration: none; font-weight: 600;';
                            link.title = 'Click to view JQL query';
                            link.onclick = (e) => {
                                e.preventDefault();
                                // Copy JQL to clipboard and show in input
                                document.getElementById('customJql').value = jql;
                                navigator.clipboard.writeText(jql).then(() => {
                                    alert(`JQL query copied to clipboard and set in query field:\n\n${jql}`);
                                }).catch(() => {
                                    document.getElementById('customJql').value = jql;
                                    alert(`JQL query set in query field:\n\n${jql}`);
                                });
                            };
                            td.appendChild(link);
                        } else {
                            td.textContent = count || '0';
                            td.style.color = '#999';
                        }
                        
                        row.appendChild(td);
                    });
                    
                    // Highlight overdue rows
                    if (issue.duedate) {
                        const dueDate = new Date(issue.duedate);
                        const now = new Date();
                        now.setHours(0, 0, 0, 0);
                        dueDate.setHours(0, 0, 0, 0);
                        const status = (issue.status?.name || issue.status || '').toLowerCase();
                        const isResolved = status.includes('done') || status.includes('closed') || status.includes('resolved');
                        if (dueDate < now && !isResolved) {
                            row.style.borderLeft = '4px solid #ef4444';
                            row.style.background = '#fef2f2';
                        }
                    }
                    
                    // Add click handler to open metrics modal
                    row.style.cursor = 'pointer';
                    row.onclick = (e) => {
                        // Don't open modal if clicking on links
                        if (e.target.tagName === 'A') return;
                        const featureKey = issue.key;
                        if (featureKey) {
                            openFeatureModal(featureKey);
                        }
                    };
                    
                    tableBody.appendChild(row);
                });
                
                console.log('‚úÖ [renderTable] Rendered', filteredIssues.length, 'rows in table body');
                console.log('‚úÖ [renderTable] Table body children count:', tableBody.children.length);
            }

            // CRITICAL: Make table visible AFTER rendering content
            if (issuesTable) {
                issuesTable.style.display = 'table';
                issuesTable.style.visibility = 'visible';
                issuesTable.style.width = '100%';
                issuesTable.style.opacity = '1';
                console.log('‚úÖ [renderTable] Table element made visible');
            }
            
            // Ensure container and wrapper are visible (already declared above)
            if (tableContainer) {
                tableContainer.style.display = 'block';
                tableContainer.style.visibility = 'visible';
                tableContainer.style.opacity = '1';
                console.log('‚úÖ [renderTable] Table container made visible');
            }
            
            if (tableWrapper) {
                tableWrapper.style.display = 'block';
                tableWrapper.style.visibility = 'visible';
                tableWrapper.style.opacity = '1';
                console.log('‚úÖ [renderTable] Table wrapper made visible');
            }
            
            // Final verification
            const finalRowCount = tableBody ? tableBody.querySelectorAll('tr').length : 0;
            console.log('‚úÖ [renderTable] FINAL STATE:', {
                tableDisplay: issuesTable ? issuesTable.style.display : 'N/A',
                tableVisibility: issuesTable ? issuesTable.style.visibility : 'N/A',
                containerDisplay: tableContainer ? tableContainer.style.display : 'N/A',
                rowsInBody: finalRowCount,
                filteredIssuesCount: filteredIssues.length
            });
            
            // Scroll to table if it has data
            if (filteredIssues.length > 0 && tableContainer) {
                setTimeout(() => {
                    tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
            
            console.log('üü¢ [renderTable] END - Complete');
        }

        // Pagination and search functions
        function changePageSize() {
            const select = document.getElementById('pageSize');
            if (select) {
                const newPageSize = parseInt(select.value);
                if (!isNaN(newPageSize) && newPageSize > 0) {
                    pageSize = newPageSize;
                currentPage = 1;
                renderTable();
                }
            }
        }

        function changePage(direction) {
            const totalIssues = Array.isArray(filteredIssues) ? filteredIssues.length : 0;
            const validPageSize = (typeof pageSize === 'number' && !isNaN(pageSize) && pageSize > 0) ? pageSize : 50;
            const validCurrentPage = (typeof currentPage === 'number' && !isNaN(currentPage) && currentPage > 0) ? currentPage : 1;
            const totalPages = totalIssues > 0 ? Math.ceil(totalIssues / validPageSize) : 1;
            const newPage = validCurrentPage + direction;
            if (newPage >= 1 && newPage <= totalPages && totalPages > 0) {
                currentPage = newPage;
                renderTable();
                // Scroll to top of table
                document.querySelector('.table-wrapper')?.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function searchTable() {
            const searchInput = document.getElementById('tableSearch');
            if (searchInput) {
                searchQuery = searchInput.value.toLowerCase().trim();
                currentPage = 1;
                applyFiltersAndSearch();
            }
        }

        function applyFiltersAndSearch() {
            // Start with all current issues
            let filtered = [...currentIssues];
            
            // Apply search query only
            if (searchQuery) {
                filtered = filtered.filter(issue => {
                    return Object.values(issue).some(value => 
                        String(value).toLowerCase().includes(searchQuery)
                    );
                });
            }
            
            filteredIssues = filtered;
            renderTable();
        }

        // Generate base JQL query for feature/initiative (for finding related tickets)
        function generateBaseJQL(featureKey) {
            if (!featureKey || featureKey.trim() === '') {
                return '';
            }
            
            const key = featureKey.trim().toUpperCase();
            
            // Base JQL query to find all related tickets
            return `(
                key = ${key} OR
                "Parent Link" = ${key} OR
                "FEAT ID" ~ ${key} OR
                "FEAT Number" = ${key} OR
                issueFunction in portfolioChildrenOf("key=${key}") OR
                issueFunction in issuesInEpics("issueFunction in portfolioChildrenOf('key=${key}')") OR
                issueFunction in subtasksOf("key=${key}") OR
                issueFunction in subtasksOf("issueFunction in issuesInEpics(\"issueFunction in portfolioChildrenOf('key=${key}') \")")
            )`;
        }

        // Generate JQL for specific ticket type
        function generateJQLForType(featureKey, type) {
            const baseJQL = generateBaseJQL(featureKey);
            if (!baseJQL) return '';
            
            const typeConditions = {
                'tasks': 'AND (issuetype = Task OR issuetype = Story OR issuetype = Sub-task) AND status != Done AND status != Closed',
                'bugs': 'AND issuetype = Bug AND status != Done AND status != Closed',
                'tests': 'AND (issuetype = Test OR issuetype = "Test Case" OR issuetype = "Test Execution") AND status != Done AND status != Closed',
                'other': 'AND issuetype NOT IN (Feature, Initiative, Epic, Bug, Task, Story, Sub-task, Test, "Test Case", "Test Execution") AND status != Done AND status != Closed'
            };
            
            return baseJQL + (typeConditions[type] || '');
        }

        // Count related tickets of a specific type from allIssues
        function countRelatedTickets(featureKey, type) {
            // Ensure allIssues is defined
            if (typeof allIssues === 'undefined') {
                console.warn('allIssues is not defined, using currentIssues as fallback');
                allIssues = currentIssues || [];
            }
            
            if (!allIssues || allIssues.length === 0 || !featureKey) return 0;
            
            const key = featureKey.trim().toUpperCase();
            
            // Filter allIssues to find related tickets
            const related = allIssues.filter(issue => {
                if (!issue || !issue.key) return false;
                
                const issueKey = (issue.key || '').toUpperCase();
                
                // Get issue fields (handle both direct properties and nested fields)
                const issueType = typeof issue.issuetype === 'string' 
                    ? issue.issuetype 
                    : (issue.issuetype?.name || issue.issuetype || '').toLowerCase();
                const status = typeof issue.status === 'string'
                    ? issue.status
                    : (issue.status?.name || issue.status || '').toLowerCase();
                const isDone = status === 'done' || status === 'closed' || status === 'resolved';
                
                // Check if issue is related to this feature
                // Simple check: if issue key starts with feature key or is a subtask of it
                const isRelated = issueKey === key || 
                                 issueKey.startsWith(key + '-') ||
                                 (issue.parentLink && issue.parentLink.toUpperCase() === key) ||
                                 (issue.parent && issue.parent.toUpperCase() === key);
                
                if (!isRelated) return false;
                
                // Filter by type and status
                if (type === 'tasks') {
                    return (issueType.includes('task') || issueType.includes('story') || issueType.includes('sub-task')) && !isDone;
                } else if (type === 'bugs') {
                    return issueType.includes('bug') && !isDone;
                } else if (type === 'tests') {
                    return (issueType.includes('test') || issueType.includes('test case') || issueType.includes('test execution')) && !isDone;
                } else if (type === 'other') {
                    const normalizedType = issueType.toLowerCase();
                    return !normalizedType.includes('feature') && 
                           !normalizedType.includes('initiative') && 
                           !normalizedType.includes('epic') &&
                           !normalizedType.includes('bug') &&
                           !normalizedType.includes('task') &&
                           !normalizedType.includes('story') &&
                           !normalizedType.includes('sub-task') &&
                           !normalizedType.includes('test') && !isDone;
                }
                return false;
            });
            
            return related.length;
        }

        // Fetch all tickets related to a feature/initiative
        async function fetchFeatureTickets() {
            const featureKey = document.getElementById('featureKey').value.trim();
            
            if (!featureKey) {
                alert('Please enter a Feature/Initiative key (e.g., ERA-21110) or a filter query (e.g., filter = 165194)');
                return;
            }
            
            try {
                let jql;
                
                // Check if input is a filter query (starts with "filter" or "filter=")
                const normalizedInput = featureKey.toLowerCase().trim();
                if (normalizedInput.startsWith('filter') || normalizedInput.startsWith('filter=')) {
                    // It's a filter query - normalize it to proper JQL format
                    if (normalizedInput.includes('=')) {
                        // Extract the filter ID (e.g., "filter=165194" -> "filter = 165194")
                        const parts = featureKey.split('=');
                        if (parts.length === 2) {
                            const filterId = parts[1].trim();
                            jql = `filter = ${filterId}`;
                        } else {
                            // Already in correct format or more complex, use as-is
                            jql = featureKey.replace(/filter\s*=/i, 'filter =');
                        }
                    } else {
                        // Already in correct format
                        jql = featureKey;
                    }
                    console.log('üîç Detected filter query, using JQL:', jql);
                } else {
                    // It's a feature key - generate complex JQL
                    jql = generateFeatureJQL(featureKey);
                console.log('üîç Generated JQL for feature:', jql);
                }
                
                // Set the JQL in the input field
                document.getElementById('customJql').value = jql;
                
                // Fetch the data
                await fetchAllData();
            } catch (err) {
                console.error('Error generating feature JQL:', err);
                alert('Error: ' + err.message);
            }
        }

        // Fetch tickets for a specific feature (called from drill-down)
        async function fetchFeatureTicketsFor(featureKey, fromExecutiveView = false) {
            if (!featureKey) {
                alert('Feature key is required');
                return;
            }
            
            try {
                const jql = generateFeatureJQL(featureKey);
                console.log('üîç Generated JQL for feature:', jql);
                
                // Set the JQL in the input field
                document.getElementById('customJql').value = jql;
                
                // Set the feature key in the feature selector
                document.getElementById('featureKey').value = featureKey;
                
                // Highlight the feature chip if it exists
                document.querySelectorAll('.feature-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
                const featureChip = document.getElementById(`feature-chip-${featureKey}`);
                if (featureChip) {
                    featureChip.classList.add('active');
                }
                
                // Fetch the data
                await fetchAllData();
                
                // Switch back to dashboard view if coming from executive view
                if (fromExecutiveView) {
                    showDashboard();
                }
                
                // Scroll to the table
                setTimeout(() => {
                    document.getElementById('issuesTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            } catch (err) {
                console.error('Error generating feature JQL:', err);
                alert('Error: ' + err.message);
            }
        }

        function clearFeatureSearch() {
            document.getElementById('featureKey').value = '';
            document.getElementById('customJql').value = 'filter = 165194';
            // Clear active chip highlight
            document.querySelectorAll('.feature-chip').forEach(chip => {
                chip.classList.remove('active');
            });
        }

        // Populate clickable features list
        function populateFeaturesList(issues) {
            const featuresListContainer = document.getElementById('featuresListContainer');
            const featuresList = document.getElementById('featuresList');
            
            if (!featuresListContainer || !featuresList) return;
            
            // Get all features and initiatives
            const features = issues.filter(issue => {
                const type = (issue.issuetype || '').toLowerCase();
                return type.includes('feature') || type.includes('initiative');
            });
            
            if (features.length === 0) {
                featuresListContainer.style.display = 'none';
                return;
            }
            
            featuresListContainer.style.display = 'block';
            featuresList.innerHTML = '';
            
            features.forEach(feature => {
                const chip = document.createElement('div');
                chip.className = 'feature-chip';
                chip.id = `feature-chip-${feature.key}`;
                chip.onclick = () => drillDownToFeature(feature.key);
                
                const status = feature.status || 'Unknown';
                const statusColor = status.toLowerCase() === 'done' || status.toLowerCase() === 'closed' ? '#10b981' : 
                                   status.toLowerCase().includes('progress') ? '#3b82f6' : 
                                   status.toLowerCase() === 'resolved' ? '#f59e0b' : '#6b7280';
                
                chip.innerHTML = `
                    <span class="feature-key">${feature.key}</span>
                    <span style="color: #666; font-size: 12px;">${(feature.summary || '').substring(0, 40)}${(feature.summary || '').length > 40 ? '...' : ''}</span>
                    <span class="feature-status" style="background: ${statusColor}; color: white;">${status}</span>
                `;
                
                featuresList.appendChild(chip);
            });
        }

        // Drill down to a specific feature
        async function drillDownToFeature(featureKey) {
            await fetchFeatureTicketsFor(featureKey, false);
        }

        function updateStats(issues, totalFromAPI = null) {
            const stats = document.getElementById('stats');
            const insightsSection = document.getElementById('insightsSection');
            
            if (!Array.isArray(issues)) {
                console.warn('updateStats: issues is not an array', issues);
                issues = [];
            }
            
            // Populate features list
            populateFeaturesList(issues);
            
            // Use API total if available, otherwise use filtered issues count
            const totalIssues = totalFromAPI && totalFromAPI > 0 ? totalFromAPI : issues.length;
            
            // Helper function to get status string
            function getStatusString(issue) {
                if (!issue || !issue.status) return '';
                if (typeof issue.status === 'string') return issue.status;
                if (typeof issue.status === 'object') return issue.status.name || issue.status.value || '';
                return String(issue.status || '');
            }
            
            // Dynamically create stat tiles based on actual statuses from Jira
            const statusCounts = {};
            
            // Count tickets by actual status
            issues.forEach(issue => {
                const status = getStatusString(issue);
                if (status) {
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                }
            });
            
            // Sort statuses by count (descending)
            const sortedStatuses = Object.entries(statusCounts)
                .sort((a, b) => b[1] - a[1]);
            
            console.log('üìä Status counts:', statusCounts);
            
            // Clear existing stat cards
            stats.innerHTML = '';
            
            // Add Total Tickets tile first
            const totalCard = document.createElement('div');
            totalCard.className = 'stat-card';
            totalCard.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;';
            totalCard.innerHTML = `
                <div class="stat-number" style="color: white;">${totalIssues}</div>
                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Tickets</div>
            `;
            stats.appendChild(totalCard);
            
            // Create tiles for each actual status
            const statusColors = {
                'done': '#10b981',
                'closed': '#10b981',
                'resolved': '#f59e0b',
                'in progress': '#3b82f6',
                'inprogress': '#3b82f6',
                'development': '#3b82f6',
                'to do': '#6b7280',
                'todo': '#6b7280',
                'backlog': '#6b7280',
                'open': '#6b7280',
                'blocked': '#ef4444',
                'ec commit': '#8b5cf6',
                'ec review': '#8b5cf6'
            };
            
            sortedStatuses.forEach(([status, count]) => {
                const statusLower = status.toLowerCase();
                // Find matching color or use a default
                let color = '#6b7280'; // default gray
                for (const [key, value] of Object.entries(statusColors)) {
                    if (statusLower.includes(key)) {
                        color = value;
                        break;
                    }
                }
                
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.style.cssText = `background: ${color}; color: white;`;
                card.innerHTML = `
                    <div class="stat-number" style="color: white;">${count}</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">${status}</div>
                `;
                stats.appendChild(card);
            });

            stats.style.display = 'grid';
            
            // Generate actionable insights (using simplified stats)
            generateInsights(issues, {
                total: totalIssues,
                statusCounts: statusCounts,
                pendingVerification: statusCounts['Resolved'] || statusCounts['resolved'] || 0,
                inProgress: Object.entries(statusCounts).filter(([status]) => {
                    const s = status.toLowerCase();
                    return s.includes('progress') || s.includes('development') || s.includes('review');
                }).reduce((sum, [, count]) => sum + count, 0),
                done: Object.entries(statusCounts).filter(([status]) => {
                    const s = status.toLowerCase();
                    return s.includes('done') || s.includes('closed') || s.includes('verified');
                }).reduce((sum, [, count]) => sum + count, 0),
                todo: Object.entries(statusCounts).filter(([status]) => {
                    const s = status.toLowerCase();
                    return s.includes('todo') || s.includes('backlog') || s.includes('open');
                }).reduce((sum, [, count]) => sum + count, 0),
                blocked: Object.entries(statusCounts).filter(([status]) => {
                    const s = status.toLowerCase();
                    return s.includes('blocked');
                }).reduce((sum, [, count]) => sum + count, 0)
            });
            
            insightsSection.style.display = 'block';
        }

        // Generate actionable BA/BI insights
        function generateInsights(issues, stats) {
            const insightsContent = document.getElementById('insightsContent');
            if (!insightsContent) return;
            
            insightsContent.innerHTML = '';
            
            // If no issues, show message
            if (!issues || issues.length === 0 || stats.total === 0) {
                insightsContent.innerHTML = `
                    <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 4px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 24px;">‚ÑπÔ∏è</span>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 5px 0; font-weight: 600; font-size: 16px;">No Data</h4>
                                <p style="margin: 0; color: #666; font-size: 14px;">No tickets found. Please fetch data using the "Fetch Data" button.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const insights = [];
            
            // Helper function to get status string
            function getStatusString(issue) {
                if (!issue || !issue.status) return '';
                if (typeof issue.status === 'string') return issue.status;
                if (typeof issue.status === 'object') return issue.status.name || issue.status.value || '';
                return String(issue.status || '');
            }
            
            // Pending Verification Alert
            if (stats.pendingVerification > 0) {
                const pendingTickets = issues.filter(i => getStatusString(i).toLowerCase() === 'resolved');
                insights.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: `${stats.pendingVerification} Tickets Pending Verification`,
                    message: `${stats.pendingVerification} ticket(s) are resolved and waiting for verification. These need immediate attention.`,
                    action: `Review ${stats.pendingVerification} resolved ticket(s)`,
                    tickets: pendingTickets
                });
            }
            
            // Blocked Tickets Alert
            if (stats.blocked > 0) {
                const blockedTickets = issues.filter(i => {
                    const status = getStatusString(i).toLowerCase();
                    const labels = i.labels ? (Array.isArray(i.labels) ? i.labels.join(' ').toLowerCase() : String(i.labels).toLowerCase()) : '';
                    return status.includes('blocked') || labels.includes('blocked');
                });
                insights.push({
                    type: 'critical',
                    icon: 'üö´',
                    title: `${stats.blocked} Blocked Ticket(s)`,
                    message: `${stats.blocked} ticket(s) are blocked and may be blocking other work.`,
                    action: `Unblock ${stats.blocked} ticket(s)`,
                    tickets: blockedTickets
                });
            }
            
            // Progress Health
            const progressPercentage = stats.total > 0 ? Math.round((stats.done / stats.total) * 100) : 0;
            if (progressPercentage < 50 && stats.total > 0) {
                insights.push({
                    type: 'info',
                    icon: 'üìà',
                    title: `Progress: ${progressPercentage}% Complete`,
                    message: `Only ${progressPercentage}% of tickets are verified/closed. ${stats.inProgress} in progress, ${stats.todo} to do.`,
                    action: 'Focus on completing in-progress tickets',
                    tickets: []
                });
            }
            
            // High In-Progress Count
            if (stats.inProgress > stats.total * 0.4 && stats.total > 0) {
                insights.push({
                    type: 'info',
                    icon: '‚ö°',
                    title: 'High Work-in-Progress',
                    message: `${stats.inProgress} tickets (${Math.round((stats.inProgress/stats.total)*100)}%) are in progress. Consider focusing to complete some before starting new ones.`,
                    action: 'Review WIP limits',
                    tickets: []
                });
            }
            
            // No insights - only show "All Good" if there are actually issues
            if (insights.length === 0 && stats.total > 0) {
                insights.push({
                    type: 'success',
                    icon: '‚úÖ',
                    title: 'All Good!',
                    message: 'No immediate action items. All tickets are progressing well.',
                    action: '',
                    tickets: []
                });
            } else if (stats.total === 0) {
                insights.push({
                    type: 'info',
                    icon: '‚ÑπÔ∏è',
                    title: 'No Data',
                    message: 'No tickets found. Please fetch data using the "Fetch Data" button.',
                    action: 'Click "Fetch Data" to load tickets',
                    tickets: []
                });
            }
            
            // Display insights
            insights.forEach(insight => {
                const insightCard = document.createElement('div');
                insightCard.className = 'insight-card';
                insightCard.style.cssText = `
                    background: ${insight.type === 'critical' ? '#fee2e2' : insight.type === 'warning' ? '#fef3c7' : insight.type === 'success' ? '#d1fae5' : '#dbeafe'};
                    border-left: 4px solid ${insight.type === 'critical' ? '#dc2626' : insight.type === 'warning' ? '#f59e0b' : insight.type === 'success' ? '#10b981' : '#3b82f6'};
                    padding: 15px;
                    margin-bottom: 10px;
                    border-radius: 4px;
                `;
                
                insightCard.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 24px;">${insight.icon}</span>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0; font-weight: 600; font-size: 16px;">${insight.title}</h4>
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">${insight.message}</p>
                            ${insight.action ? `<div style="font-size: 12px; color: #666; font-weight: 500;">üí° ${insight.action}</div>` : ''}
                            ${insight.tickets && insight.tickets.length > 0 ? `
                                <div style="margin-top: 10px; font-size: 12px;">
                                    <strong>Affected Tickets:</strong> 
                                    ${insight.tickets.slice(0, 5).map(t => `<a href="${t.url}" target="_blank" style="color: #3b82f6; margin-left: 5px;">${t.key}</a>`).join('')}
                                    ${insight.tickets.length > 5 ? ` +${insight.tickets.length - 5} more` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                insightsContent.appendChild(insightCard);
            });
        }




        // Display summarized field (for customfield_23073)
        async function displaySummarizedField(td, value, issueKey, fieldKey) {
            if (!value || value.trim() === '') {
                td.textContent = '-';
                td.style.color = '#999';
                return;
            }
            
            // Show loading state
            td.innerHTML = '<span style="color: #666; font-size: 12px;">Summarizing...</span>';
            
            try {
                const response = await fetch('http://localhost:7842/api/summarize-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: value })
                });
                
                const data = await response.json();
                
                if (data.success && data.display) {
                    // Create a tooltip with full text
                    const summaryDiv = document.createElement('div');
                    summaryDiv.style.cssText = 'cursor: help; position: relative;';
                    summaryDiv.textContent = data.display;
                    summaryDiv.title = value; // Full text on hover
                    
                    // Add click to show full text
                    summaryDiv.onclick = () => {
                        showFullTextModal(value, issueKey, fieldKey, data.display);
                    };
                    
                    td.appendChild(summaryDiv);
                    td.style.color = '#333';
                } else {
                    // Fallback to truncated text
                    const truncated = value.length > 100 ? value.substring(0, 100) + '...' : value;
                    td.textContent = truncated;
                    td.title = value; // Full text on hover
                }
            } catch (err) {
                console.error('Error summarizing field:', err);
                // Fallback to truncated text
                const truncated = value.length > 100 ? value.substring(0, 100) + '...' : value;
                td.textContent = truncated;
                td.title = value; // Full text on hover
            }
        }

        // Show full text modal
        function showFullTextModal(fullText, issueKey, fieldKey, summary) {
            // Create modal similar to Confluence modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>üìÑ ${fieldKey} - ${issueKey}</h2>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px; color: #666;">Summary:</h3>
                            <div style="background: #f0f9ff; padding: 12px; border-radius: 4px; border-left: 4px solid #3b82f6;">
                                <p style="margin: 0; line-height: 1.6;">${summary || 'No summary available'}</p>
                            </div>
                        </div>
                        <div>
                            <h3 style="font-size: 16px; margin-bottom: 10px; color: #666;">Full Text:</h3>
                            <div style="background: #f8f8f8; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto;">
                                <p style="margin: 0; line-height: 1.6; white-space: pre-wrap; font-family: monospace; font-size: 13px;">${fullText}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }


        // Test and authenticate Jira token
        async function testAndAuthenticateJira(buttonElement) {
            // Get token from user input
            const token = prompt('Enter your Jira Bearer token (PAT):');
            if (!token || token.trim() === '') {
                return;
            }
            
            const cleanToken = token.trim();
            
            // Show loading state
            const button = buttonElement || event?.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Testing...';
            button.disabled = true;
            
            try {
                const response = await fetch('http://localhost:7842/api/test-jira-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Jira-Token': cleanToken
                    },
                    body: JSON.stringify({ token: cleanToken })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store token in localStorage (authenticate)
                    localStorage.setItem('jira_bearer_token', cleanToken);
                    
                    // Update button to show authenticated state
                    button.textContent = '‚úÖ Jira Authenticated';
                    button.style.background = '#10b981';
                    button.onclick = function() {
                        if (confirm('You are already authenticated. Do you want to test with a different token?')) {
                            localStorage.removeItem('jira_bearer_token');
                            button.textContent = 'üîê Test Jira';
                            button.style.background = '#3b82f6';
                            button.onclick = () => testAndAuthenticateJira(button);
                            testAndAuthenticateJira(button);
                        }
                    };
                    
                    const message = `‚úÖ Jira Token Test Successful!\n\n` +
                        `Token is valid and authenticated.\n` +
                        `Found ${data.tokenCount} token(s).\n` +
                        (data.tokens && data.tokens.length > 0 ? 
                            `Tokens:\n${data.tokens.map(t => `  - ${t.name} (created: ${t.createdAt})`).join('\n')}` : 
                            '');
                    alert(message);
                } else {
                    alert(`‚ùå Jira Token Test Failed!\n\n${data.error || 'Unknown error'}\n\n${data.details ? JSON.stringify(data.details, null, 2) : ''}`);
                }
            } catch (error) {
                console.error('Jira token test error:', error);
                alert(`‚ùå Jira Token Test Failed!\n\n${error.message || 'Network error. Please check your connection.'}`);
            } finally {
                if (button.textContent === '‚è≥ Testing...') {
                    button.textContent = originalText;
                }
                button.disabled = false;
            }
        }
        
        // Test and authenticate Confluence token
        async function testAndAuthenticateConfluence(buttonElement) {
            // Get token from user input
            const token = prompt('Enter your Confluence Bearer token (PAT) or use Jira token if same:');
            if (!token || token.trim() === '') {
                return;
            }
            
            const cleanToken = token.trim();
            
            // Show loading state
            const button = buttonElement || event?.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Testing...';
            button.disabled = true;
            
            try {
                const response = await fetch('http://localhost:7842/api/test-confluence-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Confluence-Token': cleanToken
                    },
                    body: JSON.stringify({ token: cleanToken })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store token in localStorage (authenticate)
                    localStorage.setItem('confluence_bearer_token', cleanToken);
                    
                    // Update button to show authenticated state
                    button.textContent = '‚úÖ Confluence Authenticated';
                    button.style.background = '#10b981';
                    button.onclick = function() {
                        if (confirm('You are already authenticated. Do you want to change your token?')) {
                            localStorage.removeItem('confluence_bearer_token');
                            button.textContent = 'üîê Test Confluence';
                            button.style.background = '#8b5cf6';
                            button.onclick = () => testAndAuthenticateConfluence(button);
                            testAndAuthenticateConfluence(button);
                        }
                    };
                    
                    const message = `‚úÖ Confluence Token Test Successful!\n\n` +
                        `Token is valid and authenticated.\n` +
                        `Authentication Method: ${data.authMethod}\n` +
                        `Test Page: ${data.pageTitle || 'N/A'} (ID: ${data.pageId || 'N/A'})\n` +
                        (data.labels && data.labels.length > 0 ? 
                            `Labels: ${data.labels.join(', ')}` : 
                            'No labels found');
                    alert(message);
                } else {
                    const errorDetails = data.details ? JSON.stringify(data.details, null, 2) : '';
                    const triedMethods = data.triedMethods ? `\n\nTried methods: ${data.triedMethods.join(', ')}` : '';
                    alert(`‚ùå Confluence Token Test Failed!\n\n${data.error || 'Unknown error'}${triedMethods}\n\n${errorDetails}`);
                }
            } catch (error) {
                console.error('Confluence token test error:', error);
                alert(`‚ùå Confluence Token Test Failed!\n\n${error.message || 'Network error. Please check your connection.'}`);
            } finally {
                if (button.textContent === '‚è≥ Testing...') {
                    button.textContent = originalText;
                }
                button.disabled = false;
            }
        }

        // Extract Confluence page title from URL
        function extractConfluencePageTitle(url, fieldId) {
            if (!url || confluencePageTitles[fieldId]) return; // Already extracted
            
            try {
                // Extract title from URL: /pages/123456789/Page+Title or /pages/123456789/Page-Title
                const titleMatch = url.match(/\/pages\/\d+\/([^\/\?]+)/);
                if (titleMatch) {
                    let title = decodeURIComponent(titleMatch[1]);
                    // Replace + and - with spaces, clean up
                    title = title.replace(/\+/g, ' ').replace(/-/g, ' ').trim();
                    if (title) {
                        confluencePageTitles[fieldId] = title;
                        console.log(`‚úÖ Extracted Confluence page title for ${fieldId}: "${title}"`);
                        // Update header if table is already rendered
                        if (tableConfig) {
                            createTableHeader();
                        }
                    }
                }
            } catch (err) {
                console.warn(`‚ö†Ô∏è Error extracting Confluence title from ${url}:`, err);
            }
        }

        // Load field names from Jira
        async function loadFieldNames() {
            try {
                const storedToken = localStorage.getItem('jira_bearer_token');
                if (!storedToken) {
                    console.log('‚ÑπÔ∏è No token available, skipping field name load');
                    return;
                }
                
                const response = await fetch('http://localhost:7842/api/field-names', {
                    headers: {
                        'X-Jira-Token': storedToken
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.fieldMap) {
                        Object.keys(data.fieldMap).forEach(fieldId => {
                            fieldNameMap[fieldId] = data.fieldMap[fieldId];
                        });
                        console.log(`‚úÖ Loaded ${Object.keys(fieldNameMap).length} field names`);
                        
                        // Log specific custom fields we care about
                        if (fieldNameMap['customfield_23073']) {
                            console.log(`‚úÖ Found customfield_23073: "${fieldNameMap['customfield_23073']}"`);
                        } else {
                            console.warn(`‚ö†Ô∏è customfield_23073 not found in field map`);
                        }
                        if (fieldNameMap['customfield_23560']) {
                            console.log(`‚úÖ Found customfield_23560: "${fieldNameMap['customfield_23560']}"`);
                        } else {
                            console.warn(`‚ö†Ô∏è customfield_23560 not found in field map`);
                        }
                        
                        // Recreate table header with updated field names
                        if (tableConfig) {
                            createTableHeader();
                        }
                    }
                } else {
                    console.warn('‚ö†Ô∏è Could not load field names:', response.status);
                    const errorText = await response.text();
                    console.warn('‚ö†Ô∏è Error response:', errorText);
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è Error loading field names:', err.message);
                // Non-critical, continue without names
            }
        }

        // Check authentication status on load
        function checkAuthStatus() {
            const jiraToken = localStorage.getItem('jira_bearer_token');
            const confluenceToken = localStorage.getItem('confluence_bearer_token');
            
            // Update Jira button if authenticated
            const jiraButton = document.querySelector('button[onclick*="testAndAuthenticateJira"]');
            if (jiraToken && jiraButton) {
                jiraButton.textContent = '‚úÖ Jira Authenticated';
                jiraButton.style.background = '#10b981';
                jiraButton.onclick = function() {
                    if (confirm('You are already authenticated. Do you want to test with a different token?')) {
                        localStorage.removeItem('jira_bearer_token');
                        jiraButton.textContent = 'üîê Test Jira';
                        jiraButton.style.background = '#3b82f6';
                        jiraButton.onclick = () => testAndAuthenticateJira(jiraButton);
                        testAndAuthenticateJira(jiraButton);
                    }
                };
            } else if (jiraButton && !jiraToken) {
                // Not authenticated - ensure button shows "Test Jira"
                jiraButton.textContent = 'üîê Test Jira';
                jiraButton.style.background = '#3b82f6';
                jiraButton.onclick = () => testAndAuthenticateJira(jiraButton);
            }
            
            // Update Confluence button if authenticated
            const confluenceButton = document.querySelector('button[onclick*="testAndAuthenticateConfluence"]');
            if (confluenceToken && confluenceButton) {
                confluenceButton.textContent = '‚úÖ Confluence Authenticated';
                confluenceButton.style.background = '#10b981';
                confluenceButton.onclick = function() {
                    if (confirm('You are already authenticated. Do you want to test with a different token?')) {
                        localStorage.removeItem('confluence_bearer_token');
                        confluenceButton.textContent = 'üîê Test Confluence';
                        confluenceButton.style.background = '#8b5cf6';
                        confluenceButton.onclick = () => testAndAuthenticateConfluence(confluenceButton);
                        testAndAuthenticateConfluence(confluenceButton);
                    }
                };
            } else if (confluenceButton && !confluenceToken) {
                // Not authenticated - ensure button shows "Test Confluence"
                confluenceButton.textContent = 'üîê Test Confluence';
                confluenceButton.style.background = '#8b5cf6';
                confluenceButton.onclick = () => testAndAuthenticateConfluence(confluenceButton);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing application...');
            
            try {
            // Check authentication status
            checkAuthStatus();
            
            // Add a small delay to ensure server is ready
            await new Promise(resolve => setTimeout(resolve, 1000));
            
                console.log('Loading table configuration...');
                await loadTableConfig();
                
                // Don't create table header until data is fetched
                // Table container is hidden by default
                console.log('‚úÖ Application initialized. Click "Fetch Data" to load tickets.');
            } catch (initError) {
                console.error('‚ùå Error during initialization:', initError);
                const errorDiv = document.getElementById('error');
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    const errorMsg = document.getElementById('errorMessage');
                    if (errorMsg) {
                        errorMsg.textContent = `Initialization error: ${initError.message || 'Unknown error'}`;
                    }
                }
            }
        });

        // Auto-refresh removed - user must manually fetch data

        // Feature Metrics Modal
        let featureMetricsModal = null;
        let currentFeatureKey = null;
        let featureMetricsCharts = {};

        function initFeatureModal() {
            featureMetricsModal = document.getElementById('featureMetricsModal');
            if (!featureMetricsModal) {
                console.error('Feature metrics modal not found');
                return;
            }

            const closeBtn = featureMetricsModal.querySelector('.feature-modal-close');
            if (closeBtn) {
                closeBtn.onclick = () => closeFeatureModal();
            }

            featureMetricsModal.onclick = (e) => {
                if (e.target === featureMetricsModal) {
                    closeFeatureModal();
                }
            };

            // No tabs needed - single view
        }

        function openFeatureModal(featureKey) {
            currentFeatureKey = featureKey;
            if (!featureMetricsModal) {
                initFeatureModal();
            }
            if (featureMetricsModal) {
                featureMetricsModal.classList.add('active');
                loadFeatureMetrics(featureKey);
            }
        }

        function closeFeatureModal() {
            if (featureMetricsModal) {
                featureMetricsModal.classList.remove('active');
            }
            Object.values(featureMetricsCharts).forEach(chart => {
                if (chart && chart.destroy) chart.destroy();
            });
            featureMetricsCharts = {};
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.metrics-tab');
            const contents = document.querySelectorAll('.metrics-tab-content');
            
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            contents.forEach(content => {
                if (content.dataset.tab === tabName) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        async function loadFeatureMetrics(featureKey) {
            const modalBody = document.querySelector('.feature-modal-body');
            if (!modalBody) return;

            modalBody.innerHTML = '<div class="loading-spinner">Loading metrics...</div>';

            try {
            const storedToken = localStorage.getItem('jira_bearer_token');
                if (!storedToken) {
                    throw new Error('Please authenticate first');
                }

                const response = await fetch(`http://localhost:7842/api/feature-metrics/${featureKey}`, {
                    headers: {
                        'X-Jira-Token': storedToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                if (data.success) {
                    renderFeatureMetrics(data.metrics, featureKey);
            } else {
                    throw new Error(data.error || 'Failed to load metrics');
                }
            } catch (error) {
                modalBody.innerHTML = `<div class="loading-spinner" style="color: #ef4444;">Error: ${error.message}</div>`;
                console.error('Error loading feature metrics:', error);
            }
        }

        function renderFeatureMetrics(metrics, featureKey) {
            const modalBody = document.querySelector('.feature-modal-body');
            const modalHeader = document.querySelector('.feature-modal-header h2');
            
            if (modalHeader) {
                modalHeader.textContent = `${featureKey} - Metrics`;
            }

            // Single clean view - no tabs
            modalBody.innerHTML = `
                ${renderKickOffEpicDueDates(metrics.kickOffEpicDueDates || {})}
                <div class="metrics-grid">
                    <!-- Story Points Progress -->
                    <div class="metric-card">
                        <h3>üìä Progress</h3>
                        <div class="metric-summary">
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Total SP</div>
                                <div class="metric-summary-value">${metrics.totalStoryPoints || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Done</div>
                                <div class="metric-summary-value" style="color: #10b981;">${metrics.completedStoryPoints || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Remaining</div>
                                <div class="metric-summary-value" style="color: #ef4444;">${metrics.remainingStoryPoints || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Progress</div>
                                <div class="metric-summary-value">${metrics.progressPercent || 0}%</div>
                            </div>
                        </div>
                        <div class="metric-chart-container">
                            <canvas id="overviewProgressChart"></canvas>
                        </div>
                    </div>

                    <!-- Tasks Created vs Resolved -->
                    <div class="metric-card">
                        <h3>üìã Tasks</h3>
                        <div class="metric-summary">
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Created</div>
                                <div class="metric-summary-value">${metrics.tasks?.totalCreated || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Resolved</div>
                                <div class="metric-summary-value" style="color: #10b981;">${metrics.tasks?.totalResolved || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Open</div>
                                <div class="metric-summary-value" style="color: #ef4444;">${metrics.tasks?.open || 0}</div>
                            </div>
                        </div>
                        <div class="metric-chart-container">
                            <canvas id="tasksCreatedResolvedChart"></canvas>
                        </div>
                    </div>

                    <!-- Bugs Created vs Resolved -->
                    <div class="metric-card">
                        <h3>üêõ Bugs</h3>
                        <div class="metric-summary">
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Created</div>
                                <div class="metric-summary-value">${metrics.bugs?.totalCreated || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Resolved</div>
                                <div class="metric-summary-value" style="color: #10b981;">${metrics.bugs?.totalResolved || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Open</div>
                                <div class="metric-summary-value" style="color: #ef4444;">${metrics.bugs?.open || 0}</div>
                            </div>
                        </div>
                        <div class="metric-chart-container">
                            <canvas id="bugsCreatedResolvedChart"></canvas>
                        </div>
                    </div>

                    <!-- Tests Created vs Resolved -->
                    <div class="metric-card">
                        <h3>üß™ Tests</h3>
                        <div class="metric-summary">
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Created</div>
                                <div class="metric-summary-value">${metrics.tests?.totalCreated || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Resolved</div>
                                <div class="metric-summary-value" style="color: #10b981;">${metrics.tests?.totalResolved || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Open</div>
                                <div class="metric-summary-value" style="color: #ef4444;">${metrics.tests?.open || 0}</div>
                            </div>
                        </div>
                        <div class="metric-chart-container">
                            <canvas id="testsCreatedResolvedChart"></canvas>
                        </div>
                    </div>

                    <!-- Timeline Table -->
                    <div class="metric-card" style="grid-column: 1 / -1;">
                        <h3>üìÖ Timeline</h3>
                        <div class="metric-summary">
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Pending SP</div>
                                <div class="metric-summary-value">${metrics.totalPendingStoryPoints || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Items Due</div>
                                <div class="metric-summary-value">${metrics.itemsDue || 0}</div>
                            </div>
                            <div class="metric-summary-item">
                                <div class="metric-summary-label">Overdue</div>
                                <div class="metric-summary-value" style="color: #ef4444;">${metrics.overdue || 0}</div>
                            </div>
                        </div>
                        ${renderTimelineTable(metrics.timeline || [])}
                    </div>
                </div>
            `;

            setTimeout(() => {
                renderCharts(metrics);
            }, 100);
        }

        function renderKickOffEpicDueDates(kickOffData) {
            if (!kickOffData || !kickOffData.tasks || kickOffData.tasks.length === 0) {
                return '';
            }

            const tasks = kickOffData.tasks;
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            // Group by due date
            const tasksByDate = {};
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const dateKey = dueDate.toISOString().split('T')[0];
                if (!tasksByDate[dateKey]) {
                    tasksByDate[dateKey] = [];
                }
                tasksByDate[dateKey].push(task);
            });

            // Sort dates
            const sortedDates = Object.keys(tasksByDate).sort();

            let timelineHTML = '';
            sortedDates.forEach(dateKey => {
                const date = new Date(dateKey);
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                const isOverdue = date < now;
                const isToday = dateKey === now.toISOString().split('T')[0];
                
                const dateClass = isOverdue ? 'overdue' : (isToday ? 'today' : 'upcoming');
                
                timelineHTML += `
                    <div class="due-date-group ${dateClass}">
                        <div class="due-date-header">
                            <span class="due-date-label">${dateStr}</span>
                            <span class="due-date-count">${tasksByDate[dateKey].length} task${tasksByDate[dateKey].length > 1 ? 's' : ''}</span>
                        </div>
                        <div class="due-date-tasks">
                            ${tasksByDate[dateKey].map(task => {
                                const statusClass = task.status?.toLowerCase().replace(/\s+/g, '-') || 'todo';
                                return `
                                    <div class="due-date-task">
                                        <span class="task-key"><a href="https://jira.nutanix.com/browse/${task.key}" target="_blank">${task.key}</a></span>
                                        <span class="task-summary">${task.summary}</span>
                                        <span class="status-badge ${statusClass}">${task.status}</span>
                                        <span class="task-assignee">${task.assignee}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            return `
                <div class="kickoff-epic-section">
                    <h3>üìÖ Kick Off Epic: ${kickOffData.epicKey || 'N/A'} - ${kickOffData.epicSummary || 'N/A'}</h3>
                    <div class="due-dates-timeline">
                        ${timelineHTML}
                    </div>
                </div>
            `;
        }

        function renderTimelineTable(timelineItems) {
            if (timelineItems.length === 0) {
                return '<div class="loading-spinner">No timeline data available</div>';
            }

            let tableRows = '';
            timelineItems.forEach(item => {
                const dueDate = item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A';
                const statusClass = item.status?.toLowerCase().replace(/\s+/g, '-') || 'todo';
                const priorityClass = item.priority?.toLowerCase().replace(/\s+/g, '-') || 'medium';
                tableRows += `
                    <tr>
                        <td><strong>${item.key || 'N/A'}</strong></td>
                        <td>${item.summary || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${item.status || 'N/A'}</span></td>
                        <td>${dueDate}</td>
                        <td><span class="story-point-badge">${item.storyPoints || 0}</span></td>
                        <td>${item.assignee || 'Unassigned'}</td>
                        <td>${item.components || 'None'}</td>
                        <td><span class="priority-badge ${priorityClass}">${item.priority || 'N/A'}</span></td>
                    </tr>
                `;
            });

            return `
                <table class="timeline-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Summary</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th>SP</th>
                            <th>Assignee</th>
                            <th>Components</th>
                            <th>Priority</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        function renderCharts(metrics) {
            // Progress chart
            if (metrics.totalStoryPoints) {
                const ctx1 = document.getElementById('overviewProgressChart');
                if (ctx1) {
                    featureMetricsCharts.overview = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['Done', 'Remaining'],
                            datasets: [{
                                data: [metrics.completedStoryPoints || 0, metrics.remainingStoryPoints || 0],
                                backgroundColor: ['#10b981', '#e5e5e5']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }
            }

            // Tasks chart
            if (metrics.tasks?.timeline && metrics.tasks.timeline.length > 0) {
                renderCreatedResolvedChart('tasks', metrics.tasks.timeline);
            }

            // Bugs chart
            if (metrics.bugs?.timeline && metrics.bugs.timeline.length > 0) {
                renderCreatedResolvedChart('bugs', metrics.bugs.timeline);
            }

            // Tests chart
            if (metrics.tests?.timeline && metrics.tests.timeline.length > 0) {
                renderCreatedResolvedChart('tests', metrics.tests.timeline);
            }
        }

        function renderCreatedResolvedChart(type, timeline) {
            const ctx = document.getElementById(`${type}CreatedResolvedChart`);
            if (!ctx || !timeline || timeline.length === 0) {
                // Show placeholder if no data
                if (ctx) {
                    ctx.parentElement.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No timeline data available</div>';
                }
                return;
            }

            const dates = timeline.map(t => {
                const date = new Date(t.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const created = timeline.map(t => t.created || 0);
            const resolved = timeline.map(t => t.resolved || 0);

            featureMetricsCharts[type] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Created',
                            data: created,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Resolved',
                            data: resolved,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>

    <!-- Feature Metrics Modal -->
    <div id="featureMetricsModal" class="feature-modal">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <h2>Feature Metrics</h2>
                <span class="feature-modal-close">&times;</span>
            </div>
            <div class="feature-modal-body">
                <div class="loading-spinner">Loading...</div>
            </div>
        </div>
    </div>
</body>
</html>
